---
title: "4 IVIVE and POD Comparisons"
author: "Katie Paul Friedman"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    collapsed: yes
    df_print: paged
    lightbox: no
    number_sections: yes
    self_contained: yes
    thumbnails: no
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{r setup, warning=FALSE, message=FALSE, echo=FALSE}
library(caret)
library(cowplot)
library(data.table)
library(DescTools)
library(dplyr)
library(DT)
library(ggplot2)
library(ggpmisc)
library(ggstance)
library(gplots)
library(gridExtra)
library(httk)
library(kableExtra)
library(jtools)
library(openxlsx)
library(parallel)
library(plotly)
library(purrr)
library(randomForest)
library(RMySQL)
library(tibble)
library(tictoc)
library(tidyr)
#devtools::install_git('http://ncct-bitbucket.epa.gov/scm/tox/tcpl.git', ref ='TOX-337', force=TRUE)
library(tcpl)
library(viridis)

```

# Load Data {.tabset .tabset-fade .tabset-pills}

## Toxicodynamic NAM data

```{r, warning=FALSE}

#load('./source/tier1_NAMs_apcra_pro_03072022.RData')
#load('./source/tier1_NAMs_apcra_pro_02102023.RData')
#load('./source/in_vitro/tier1_NAMs_apcra_pro_04032023.RData')
load('./source/in_vitro/tier1_NAMs_apcra_pro_02262024.RData')
colnames(asnm.tier1) # this is the file for all BMDs/ACCs
# mega.mc5.hitc1 may be useful if we want to apply armitage model when BSK data are updated

```

## In vivo data for comparison
+ ToxVal 9.4 PODs
+ APCRA retrospective case study PODs


```{r, warning=FALSE}

load('./source/in_vivo/apcra_pro_toxval_v9_4_PODs.RData')
apcra.ret <- as.data.table(read.xlsx('./source/chem/Supp_File_2_pod_ratio_master_final.xlsx', sheet=1)) # for comparison

```

```{r, warning=FALSE, eval=FALSE, echo=FALSE}

# Loading Supplemental File from Aurisano et al. 2023

aurisano2023 <- as.data.table(read.xlsx('./source/in_vivo/Supplemental Excel File EHP11524-revised.xlsx', sheet=6))

aurisano2023 <- aurisano2023[-c(1)] # remove first line of formatting from this file
names(aurisano2023) <- aurisano2023 %>% slice(1) %>% unlist()

aurisano2023 <- aurisano2023[,c(1:10)] # non-reproductive/developmental PODs only in first set of 10 columns
aurisano2023 <- aurisano2023 %>% slice(-1)

head(aurisano2023)

```

## AQC information

```{r, warning=FALSE}

ad.tbl <- as.data.table(read.xlsx('./source/chem/apcra_chem_ad.xlsx', sheet='apcra_ad', colNames = TRUE))

```

## Toxicokinetic data additions

* 137 chemicals have human HTTK data prior to loading in silico

```{r, warning=FALSE}
#asnm.tier1$CASRN <- apcra.list$CASRN[match(asnm.tier1$dsstox_substance_id, apcra.list$DTXSID)] # there were deformatted CASRN causing a bug

httk.chem.tbl <- as.data.table(chem.physical_and_invitro.data)
asnm.tier1$CASRN <- httk.chem.tbl$CAS[match(asnm.tier1$dsstox_substance_id, httk.chem.tbl$DTXSID)]

asnm.tier1.df <- as.data.frame(subset(asnm.tier1, CASRN %in% get_cheminfo(species=c('Human'))))
```

* Add the Health Canada data supplied by Marc Beal.
* With this contribution, we are at 154 substances that have bioactivity and HTTK.

```{r, warning=FALSE}

hc.httk <- as.data.table(read.xlsx('./source/httk/20191025-Health_Canada_Prospective_Data_HTTK.xlsx', sheet = 'add_chemtable', colNames = TRUE))

#hc.httk[is.na(Human.Funbound.plasma)] # true for DTXSID7023938 only

hc.httk[is.na(Human.Funbound.plasma), Human.Funbound.plasma := 0] # bug in HTTK is that it will not run 3 compss if is.na(Fup), so set to zero
hc.httk.df <- as.data.frame(hc.httk)

chem.physical_and_invitro.data <- add_chemtable(hc.httk.df,
                                                current.table=chem.physical_and_invitro.data,
                                                data.list=list(Compound="Compound",
                                                               CAS="CAS",
                                                               DTXSID="DTXSID",
                                                               Clint="Human.Clint",
                                                               #Clint.pValue="Human.Clint.pValue", # don't have it
                                                               Funbound.plasma="Human.Funbound.plasma",
                                                               #LogP="logP",                   
                                                               MW="MW",
                                                               Species="Species",
                                                               Reference="Human.Clint.Reference"
                                                               #pKa_Accept="pKa_Accept", # don't have this
                                                               #pKa_Donor="pKa_Donor" # don't have this
                                                ),
                                                overwrite=T)

```

* Now have 151 with 3 compss after loading HC HTTK data.
* Now have 131 chem with pbtk model HTTK data.

```{r, warning=FALSE}
asnm.tier1.df <- as.data.frame(subset(asnm.tier1, CASRN %in% get_cheminfo(species=c('Human'), model="3compartmentss"))) #148
asnm.tier1.df.pbtk <- as.data.frame(subset(asnm.tier1, CASRN %in% get_cheminfo(species=c('Human'), model="pbtk"))) #131
```

```{r, warning=FALSE}

httk.chem.tbl <- as.data.table(chem.physical_and_invitro.data)
httk.chem.tbl.apcra <- httk.chem.tbl[DTXSID %in% asnm.tier1[,dsstox_substance_id]] #196 but could include rat/other species
httk.chem.tbl.apcra.hu <- as.data.frame(subset(httk.chem.tbl.apcra, CAS %in% get_cheminfo(species=c('Human'), model="3compartmentss"))) #148

httk.chem.tbl.apcra.hu.pbtk <- as.data.frame(subset(httk.chem.tbl.apcra, CAS %in% get_cheminfo(species=c('Human'), model="pbtk"))) #131

httk.chem.tbl.apcra.3css <- httk.chem.tbl.apcra[!is.na(Human.Clint)] #166

dtxsids <- setdiff(httk.chem.tbl.apcra.3css$DTXSID, httk.chem.tbl.apcra.hu$DTXSID)
write.csv(httk.chem.tbl.apcra[DTXSID %in% dtxsids], "./source/httk/test_get_cheminfo_Human_3compss.csv")

httk.chem.tbl.apcra.3css[DTXSID %in% dtxsids]

get.cheminfo.human.3css <- as.data.frame(subset(httk.chem.tbl.apcra, CAS %in% get_cheminfo(species=c('Human'), model = "3compartmentss"))) #148

httk.chem.tbl.apcra[is.na(Human.Funbound.plasma), Human.Funbound.plasma := 0] 
httk.chem.tbl.apcra[is.na(Human.Clint.pValue), Human.Clint.pValue := 0]

```

* Here are the substances that have "missing" HTTK.
* Note that we cover all with in silico (Sipes et al 2017) approaches if we want to.

```{r, warning=FALSE}

httk.have <- subset(asnm.tier1, CASRN %in% get_cheminfo(species=c('Human'), model='3compartmentss')) # following add of Health Canada data, 148
httk.missing <- asnm.tier1[!CASRN %in% httk.have[,CASRN]] #48 chemicals - may include a bunch of aqc failures

kable(httk.missing[,c('dsstox_substance_id','chnm')])

```


* how many substances can follow pbtk model? 131

```{r, warning=FALSE}

pbtk.have <- subset(asnm.tier1, CASRN %in% get_cheminfo(species=c('Human'), model='pbtk')) #only 131 have this

```

# Calculate AEDs {.tabset .tabset-fade .tabset-pills}

* Load in silico information to fill gaps

```{r, warning=FALSE, eval=FALSE}
load_sipes2017()
load_pradeep2020()
load_dawson2021()
```
* Make the ACC values into arithmetic micromolar units.

```{r, warning=FALSE}

col.num <- c("modl_acc_5p", "ATG", "BSK", 
"NVS", "CCTE", "STM", "httr.u20s.pod.sig", "httr.mcf7.pod.sig", "httr.heparg.pod.sig", "htpp.u2os.pac.min", "Astar_BEAS2B_final", 
"Astar_HepG2_final", "Astar_HK2_final", "min.acc.targeted.nam", "min.httr.htpp.targetnams")

asnm.tier1.arith <- asnm.tier1[, (col.num) := lapply(.SD, function(x) 10^(x)), .SDcols = col.num ]

```

* subsets for 3compss, pbtk

```{r, warning=FALSE}

#for (j in seq_along(names(asnm.tier1.arith))) {
#  set(asnm.tier1,
#      i = which(is.na(asnm.tier1.arith[[j]])),
#      j = j, 
#      value = 1000)
#}


asnm.tier1.arith.3css <- subset(asnm.tier1.arith, CASRN %in% get_cheminfo(species=c('Human'), model='3compartmentss')) #168


asnm.tier1.arith.pbtk <- subset(asnm.tier1.arith, CASRN %in% get_cheminfo(species=c('Human'), model='pbtk')) #165

httk.dt <- as.data.table(chem.physical_and_invitro.data)
httk.dt <- httk.dt[DTXSID %in% apcra.list[,DTXSID]]
httk.dt[,c('Human.Clint','Human.Funbound.plasma')]

asnm.tier1.arith.3css <- as.data.table(asnm.tier1.arith)
asnm.tier1.arith.pbtk <- as.data.table(asnm.tier1.arith)


```

```{r, warning=FALSE}

colnames(asnm.tier1.arith.3css)

```
* 3 compss HTTK v2.3.0

```{r, warning=FALSE, eval=FALSE}

set.seed(1234567)

tictoc::tic() # start timer

aed50.3compss.5pacc <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.3css$modl_acc_5p,
                              asnm.tier1.arith.3css$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.3compss.atg <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.3css$ATG,
                              asnm.tier1.arith.3css$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.3compss.bsk <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.3css$BSK,
                              asnm.tier1.arith.3css$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.3compss.nvs <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.3css$NVS,
                              asnm.tier1.arith.3css$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.3compss.ccte <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.3css$CCTE,
                              asnm.tier1.arith.3css$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.3compss.stm <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.3css$STM,
                              asnm.tier1.arith.3css$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.3compss.httr.mcf7.sigbmd <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.3css$httr.mcf7.pod.sig,
                              asnm.tier1.arith.3css$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.3compss.httr.u2os.sigbmd <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.3css$httr.u20s.pod.sig,
                              asnm.tier1.arith.3css$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.3compss.httr.heparg.sigbmd <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.3css$httr.heparg.pod.sig,
                              asnm.tier1.arith.3css$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.3compss.htpp.u2os <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.3css$htpp.u2os.pac.min,
                              asnm.tier1.arith.3css$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.3compss.astar.beas2b <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.3css$Astar_BEAS2B_final,
                              asnm.tier1.arith.3css$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.3compss.astar.hepg2 <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.3css$Astar_HepG2_final,
                              asnm.tier1.arith.3css$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.3compss.astar.hek293 <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.3css$Astar_HK2_final,
                              asnm.tier1.arith.3css$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

asnm.tier1.arith.3css$aed50.3compss.5pacc <- aed50.3compss.5pacc
asnm.tier1.arith.3css$aed50.3compss.atg <- aed50.3compss.atg
asnm.tier1.arith.3css$aed50.3compss.bsk <- aed50.3compss.bsk
asnm.tier1.arith.3css$aed50.3compss.ccte <- aed50.3compss.ccte
asnm.tier1.arith.3css$aed50.3compss.nvs <- aed50.3compss.nvs
asnm.tier1.arith.3css$aed50.3compss.stm <- aed50.3compss.stm
asnm.tier1.arith.3css$aed50.3compss.atg <- aed50.3compss.atg
asnm.tier1.arith.3css$aed50.3compss.httr.mcf7.sigbmd <- aed50.3compss.httr.mcf7.sigbmd
asnm.tier1.arith.3css$aed50.3compss.httr.u2os.sigbmd <- aed50.3compss.httr.u2os.sigbmd
asnm.tier1.arith.3css$aed50.3compss.httr.heparg.sigbmd  <- aed50.3compss.httr.heparg.sigbmd 
asnm.tier1.arith.3css$aed50.3compss.htpp.u2os  <- aed50.3compss.htpp.u2os 
asnm.tier1.arith.3css$aed50.3compss.astar.beas2b  <- aed50.3compss.astar.beas2b 
asnm.tier1.arith.3css$aed50.3compss.astar.hepg2  <- aed50.3compss.astar.hepg2 
asnm.tier1.arith.3css$aed50.3compss.astar.hek293  <- aed50.3compss.astar.hek293

save(asnm.tier1.arith.3css, file='./output/asnm_tier1_arith_3css_Feb2024.RData')

tictoc::toc() # end timer
```

* PBTK version v2.3.0

```{r, warning=FALSE, eval=FALSE}

set.seed(1234567)

aed50.pbtk.5pacc <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.pbtk$modl_acc_5p,
                              asnm.tier1.arith.pbtk$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                   model='pbtk',
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday'
                                 )
                                
                              })
aed50.pbtk.atg <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.pbtk$ATG,
                              asnm.tier1.arith.pbtk$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                  model='pbtk',
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.pbtk.bsk <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.pbtk$BSK,
                              asnm.tier1.arith.pbtk$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                  model='pbtk',
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.pbtk.nvs <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.pbtk$NVS,
                              asnm.tier1.arith.pbtk$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.pbtk.ccte <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.pbtk$CCTE,
                              asnm.tier1.arith.pbtk$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.pbtk.stm <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.pbtk$STM,
                              asnm.tier1.arith.pbtk$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.pbtk.httr.mcf7.sigbmd <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.pbtk$httr.mcf7.pod.sig,
                              asnm.tier1.arith.pbtk$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.pbtk.httr.u2os.sigbmd <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.pbtk$httr.u20s.pod.sig,
                              asnm.tier1.arith.pbtk$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.pbtk.httr.heparg.sigbmd <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.pbtk$httr.heparg.pod.sig,
                              asnm.tier1.arith.pbtk$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.pbtk.htpp.u2os <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.pbtk$htpp.u2os.pac.min,
                              asnm.tier1.arith.pbtk$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.pbtk.astar.beas2b <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.pbtk$Astar_BEAS2B_final,
                              asnm.tier1.arith.pbtk$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.pbtk.astar.hepg2 <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.pbtk$Astar_HepG2_final,
                              asnm.tier1.arith.pbtk$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

aed50.pbtk.astar.hek293 <- mcmapply(mc.cores=1,
                              asnm.tier1.arith.pbtk$Astar_HK2_final,
                              asnm.tier1.arith.pbtk$CASRN,
                              FUN=function(x,y){
                                calc_mc_oral_equiv(
                                  conc=x, 
                                     chem.cas=y, 
                                     which.quantile=c(0.50),
                                     species='Human',
                                     restrictive.clearance = T, 
                                     output.units='mgpkgpday')
                                
                              })

asnm.tier1.arith.pbtk$aed50.pbtk.5pacc <- aed50.pbtk.5pacc
asnm.tier1.arith.pbtk$aed50.pbtk.atg <- aed50.pbtk.atg
asnm.tier1.arith.pbtk$aed50.pbtk.bsk <- aed50.pbtk.bsk
asnm.tier1.arith.pbtk$aed50.pbtk.ccte <- aed50.pbtk.ccte
asnm.tier1.arith.pbtk$aed50.pbtk.nvs <- aed50.pbtk.nvs
asnm.tier1.arith.pbtk$aed50.pbtk.stm <- aed50.pbtk.stm
asnm.tier1.arith.pbtk$aed50.pbtk.atg <- aed50.pbtk.atg
asnm.tier1.arith.pbtk$aed50.pbtk.httr.mcf7.sigbmd <- aed50.pbtk.httr.mcf7.sigbmd
asnm.tier1.arith.pbtk$aed50.pbtk.httr.u2os.sigbmd <- aed50.pbtk.httr.u2os.sigbmd
asnm.tier1.arith.pbtk$aed50.pbtk.httr.heparg.sigbmd  <- aed50.pbtk.httr.heparg.sigbmd 
asnm.tier1.arith.pbtk$aed50.pbtk.htpp.u2os  <- aed50.pbtk.htpp.u2os 
asnm.tier1.arith.pbtk$aed50.pbtk.astar.beas2b  <- aed50.pbtk.astar.beas2b 
asnm.tier1.arith.pbtk$aed50.pbtk.astar.hepg2  <- aed50.pbtk.astar.hepg2 
asnm.tier1.arith.pbtk$aed50.pbtk.astar.hek293  <- aed50.pbtk.astar.hek293

save(asnm.tier1.arith.pbtk, file='./output/asnm_tier1_arith_pbtk_2024.RData')


```

Load the AEDs generated as RData files.

```{r, warning=FALSE}
load(file='./output/asnm_tier1_arith_pbtk_2024.RData')
load(file='./output/asnm_tier1_arith_3css_Feb2024.RData')
```

```{r merge-aeds, warning=FALSE}

asnm.tier1.all <- merge.data.table(asnm.tier1.arith.3css,
                                   asnm.tier1.arith.pbtk[,c('dsstox_substance_id',"aed50.pbtk.5pacc", 
"aed50.pbtk.atg", "aed50.pbtk.bsk", "aed50.pbtk.ccte", "aed50.pbtk.nvs", 
"aed50.pbtk.stm", "aed50.pbtk.httr.mcf7.sigbmd", "aed50.pbtk.httr.u2os.sigbmd", 
"aed50.pbtk.httr.heparg.sigbmd", "aed50.pbtk.htpp.u2os", "aed50.pbtk.astar.beas2b", 
"aed50.pbtk.astar.hepg2", "aed50.pbtk.astar.hek293")],
by='dsstox_substance_id',
all.x=TRUE,
all.y=TRUE)

asnm.tier1.all <- asnm.tier1.all[,c("dsstox_substance_id",
                                   "aed50.3compss.5pacc", 
"aed50.3compss.atg", "aed50.3compss.bsk", "aed50.3compss.ccte", 
"aed50.3compss.nvs", "aed50.3compss.stm", "aed50.3compss.httr.mcf7.sigbmd", 
"aed50.3compss.httr.u2os.sigbmd", "aed50.3compss.httr.heparg.sigbmd", 
"aed50.3compss.htpp.u2os", "aed50.3compss.astar.beas2b", "aed50.3compss.astar.hepg2", 
"aed50.3compss.astar.hek293", "aed50.pbtk.5pacc", "aed50.pbtk.atg", 
"aed50.pbtk.bsk", "aed50.pbtk.ccte", "aed50.pbtk.nvs", "aed50.pbtk.stm", 
"aed50.pbtk.httr.mcf7.sigbmd", "aed50.pbtk.httr.u2os.sigbmd", 
"aed50.pbtk.httr.heparg.sigbmd", "aed50.pbtk.htpp.u2os", "aed50.pbtk.astar.beas2b", 
"aed50.pbtk.astar.hepg2", "aed50.pbtk.astar.hek293")]
```

```{r aed-clean-inf, warning=FALSE}

# convert all Inf to NA
for (j in 1:ncol(asnm.tier1.all)) set(asnm.tier1.all, which(is.infinite(asnm.tier1.all[[j]])), j, NA)

# log10 all AED values
cols <- c( "aed50.3compss.5pacc", "aed50.3compss.atg", 
"aed50.3compss.bsk", "aed50.3compss.ccte", "aed50.3compss.nvs", 
"aed50.3compss.stm", "aed50.3compss.httr.mcf7.sigbmd", "aed50.3compss.httr.u2os.sigbmd", 
"aed50.3compss.httr.heparg.sigbmd", "aed50.3compss.htpp.u2os", 
"aed50.3compss.astar.beas2b", "aed50.3compss.astar.hepg2", "aed50.3compss.astar.hek293", 
"aed50.pbtk.5pacc", "aed50.pbtk.atg", "aed50.pbtk.bsk", "aed50.pbtk.ccte", 
"aed50.pbtk.nvs", "aed50.pbtk.stm", "aed50.pbtk.httr.mcf7.sigbmd", 
"aed50.pbtk.httr.u2os.sigbmd", "aed50.pbtk.httr.heparg.sigbmd", 
"aed50.pbtk.htpp.u2os", "aed50.pbtk.astar.beas2b", "aed50.pbtk.astar.hepg2", 
"aed50.pbtk.astar.hek293")

asnm.tier1.logaed <- as.data.frame(asnm.tier1.all)
asnm.tier1.logaed[cols] <- lapply(asnm.tier1.logaed[cols], log10) # make the aed50s in log10-mg/kg/day
```


```{r, warning=FALSE}
# replace NA by the median for each row
asnm.tier1.pred <- as.data.frame(asnm.tier1.logaed)
asnm.tier1.pred[cols] <- t(apply(asnm.tier1.pred[cols], 1, function(x)
  replace(x, is.na(x), median(x, na.rm=TRUE))))

# add in the stuff to predict
asnm.tier1.pred <- merge.data.table(asnm.tier1.pred,
                                    toxval.apcra.summary[,c('dtxsid','p5.toxval.numeric')],
                                    by.x='dsstox_substance_id',
                                    by.y='dtxsid') %>% as.data.table()


asnm.tier1.pred[, log.p5.toxval.pod := p5.toxval.numeric] # this value was already logged, so just renaming in new column to match old code

```

# Random Forest Prediction of In Vivo POD {.tabset .tabset-fade .tabset-pills}
The goal of this section was to understand if 3Css or pbtk better outperformed each other, or if addition of certain properties or features could create a baseline RF model that clearly outperformed taking simple means or medians. This work is meant to be exploratory for the purposes of deciding if it is worth pursuing a ML model for a dataset this small. In general, the finding is that the dataset is likely too small and too little of the variance explained by any of the descriptors (AEDs, physchem properties).

The results were less than compelling, but there are some learnings. 
  + One is that 3Css vs. pbtk model made little overall difference in the prediction.
  + The Rsquared values tend to be less then 0.2
  + The RMSE values tend to approach 1.2
  + Addition of physchem properties like Fup and LogP suggests LogP would be an important feature, but fails to reduce the variance in prediction

## Baseline model

```{r, warning=FALSE}
# fill NA (missing) values with median by technology type

for (j in seq_along(names(asnm.tier1.pred))) {
  set(asnm.tier1.pred,
      i = which(is.na(asnm.tier1.pred[[j]])),
      j = j, 
      value = median(asnm.tier1.pred[[j]], na.rm = TRUE))
}
```

```{r, warning=FALSE}

colnames(asnm.tier1.pred)
asnm.tier1.pred <- asnm.tier1.pred[!p5.toxval.numeric==0]
```

```{r rf-model-default, warning=FALSE}

control <- trainControl(method='repeatedcv',
                        number=5,
                        repeats=5)

metric <- "Accuracy"
set.seed(1234567)
mtry <- sqrt(26)
tunegrid <- expand.grid(.mtry=mtry)
rf_default <- train(data=asnm.tier1.pred[,c(3:27, 29)],
                    log.p5.toxval.pod~.,
                    method='rf',
                    metric='RMSE',
                    type='regression',
                    tunegrid=tunegrid,
                    trControl=control
                    )
print(rf_default)
```

* Try just the 3css AEDs

```{r, warning=FALSE}

rf_3css <- train(data=asnm.tier1.pred[,c(3:14,29)],
                    log.p5.toxval.pod~.,
                    method='rf',
                    metric='RMSE',
                    tunegrid=tunegrid,
                    trControl=control
                    )
print(rf_3css)

```

* Try just the pbtk AEDs.
* RMSE goes up and Rsquared goes down from the 3css AEDs, but all in all similar results.

```{r, warning=FALSE}

rf_pbtk <- train(data=asnm.tier1.pred[,c(15:27,29)],
                    log.p5.toxval.pod~.,
                    method='rf',
                    metric='RMSE',
                    tunegrid=tunegrid,
                    trControl=control
                    )
print(rf_pbtk)

```

## Feature Importance and Applying RFE

* Desire to remove features with absolute correlation of 0.75 or higher.
* Model may perform better if highly correlated features are removed.
* 3css and pbtk are highly correlated for the same asnm; can't include both.

```{r, warning=FALSE}
# load the data
data(asnm.tier1.pred)

# calculate the correlation matrix
correlationMatrix <- cor(asnm.tier1.pred[,3:27])
print(correlationMatrix)

# find attributes that are highly correlated
highlyCorrelated <- findCorrelation(correlationMatrix, cutoff=0.75)
print(highlyCorrelated)

```

* Consider ranking by feature importance.
```{r, warning=FALSE}


model <- train(log.p5.toxval.pod~., data=asnm.tier1.pred[,c(3:27,29)], method='rf', trControl=control)
importance <- varImp(model, scale=FALSE)
plot(importance)


```

```{r, warning=FALSE}

print(importance)
```
* try RFE

```{r, warning=FALSE}
control <- rfeControl(functions=rfFuncs, method='cv', number=5)
results <- rfe(asnm.tier1.pred[,c(3:14,16:27)], as.matrix(asnm.tier1.pred[,28]), sizes = c(1:25), rfeControl = control)
print(results)
predictors(results)
plot(results, type = c("g","o"))



```

* Add additional features to better describe the chemicals: Fup, logP?


```{r, warning=FALSE}


asnm.tier1.pred$Fup <- httk.chem.tbl.apcra$Human.Funbound.plasma[match(asnm.tier1.pred$dsstox_substance_id,
                                                                       httk.chem.tbl.apcra$DTXSID)]

asnm.tier1.pred$logP <- httk.chem.tbl.apcra$logP[match(asnm.tier1.pred$dsstox_substance_id,
                                                                       httk.chem.tbl.apcra$DTXSID)]

asnm.tier1.pred$Fup[is.na(asnm.tier1.pred$Fup)] <- 0
asnm.tier1.pred[, Fup := tstrsplit(Fup,",", fixed=TRUE, keep=c(1))]
asnm.tier1.pred$logP[is.na(asnm.tier1.pred$logP)] <- 0


control <- rfeControl(functions=rfFuncs, method='cv', number=5)


results <- rfe(asnm.tier1.pred[,c(3:14,16:27,30:31)], as.matrix(asnm.tier1.pred[,29]), sizes = c(1:27), rfeControl = control)


print(results)
predictors(results)
plot(results, type = c("g","o"))



```

# Create AED estimates {.tabset .tabset-fade .tabset-pills}

The approach taken is to come up with one AED per chemical x technology grouping. These AEDs are highly correlated with each other and so one value per grouping makes sense.
Preference to pbtk when available (over 3css).

```{r, warning=FALSE}

asnm.tier1.all <- merge.data.table(asnm.tier1.arith.3css,
                                   asnm.tier1.arith.pbtk[,c('dsstox_substance_id',"aed50.pbtk.5pacc", 
"aed50.pbtk.atg", "aed50.pbtk.bsk", "aed50.pbtk.ccte", "aed50.pbtk.nvs", 
"aed50.pbtk.stm", "aed50.pbtk.httr.mcf7.sigbmd", "aed50.pbtk.httr.u2os.sigbmd", 
"aed50.pbtk.httr.heparg.sigbmd", "aed50.pbtk.htpp.u2os", "aed50.pbtk.astar.beas2b", 
"aed50.pbtk.astar.hepg2", "aed50.pbtk.astar.hek293")],
by='dsstox_substance_id',
all.x=TRUE,
all.y=TRUE)

asnm.tier1.all <- asnm.tier1.all[,c("dsstox_substance_id",
                                   "aed50.3compss.5pacc", 
"aed50.3compss.atg", "aed50.3compss.bsk", "aed50.3compss.ccte", 
"aed50.3compss.nvs", "aed50.3compss.stm", "aed50.3compss.httr.mcf7.sigbmd", 
"aed50.3compss.httr.u2os.sigbmd", "aed50.3compss.httr.heparg.sigbmd", 
"aed50.3compss.htpp.u2os", "aed50.3compss.astar.beas2b", "aed50.3compss.astar.hepg2", 
"aed50.3compss.astar.hek293", "aed50.pbtk.5pacc", "aed50.pbtk.atg", 
"aed50.pbtk.bsk", "aed50.pbtk.ccte", "aed50.pbtk.nvs", "aed50.pbtk.stm", 
"aed50.pbtk.httr.mcf7.sigbmd", "aed50.pbtk.httr.u2os.sigbmd", 
"aed50.pbtk.httr.heparg.sigbmd", "aed50.pbtk.htpp.u2os", "aed50.pbtk.astar.beas2b", 
"aed50.pbtk.astar.hepg2", "aed50.pbtk.astar.hek293")]

# convert all Inf to NA
for (j in 1:ncol(asnm.tier1.all)) set(asnm.tier1.all, which(is.infinite(asnm.tier1.all[[j]])), j, NA)

cols <- c( "aed50.3compss.5pacc", "aed50.3compss.atg", 
"aed50.3compss.bsk", "aed50.3compss.ccte", "aed50.3compss.nvs", 
"aed50.3compss.stm", "aed50.3compss.httr.mcf7.sigbmd", "aed50.3compss.httr.u2os.sigbmd", 
"aed50.3compss.httr.heparg.sigbmd", "aed50.3compss.htpp.u2os", 
"aed50.3compss.astar.beas2b", "aed50.3compss.astar.hepg2", "aed50.3compss.astar.hek293", 
"aed50.pbtk.5pacc", "aed50.pbtk.atg", "aed50.pbtk.bsk", "aed50.pbtk.ccte", 
"aed50.pbtk.nvs", "aed50.pbtk.stm", "aed50.pbtk.httr.mcf7.sigbmd", 
"aed50.pbtk.httr.u2os.sigbmd", "aed50.pbtk.httr.heparg.sigbmd", 
"aed50.pbtk.htpp.u2os", "aed50.pbtk.astar.beas2b", "aed50.pbtk.astar.hepg2", 
"aed50.pbtk.astar.hek293")

dup.dtxsid <- asnm.tier1.all[duplicated(asnm.tier1.all[,dsstox_substance_id]), dsstox_substance_id] # one substance had diff spids?

asnm.tier1.all <- as.data.frame(asnm.tier1.all)
asnm.tier1.all[cols] <- lapply(asnm.tier1.all[cols], log10) # make the aed50s in log10-mg/kg/day

asnm.tier1.all <- asnm.tier1.all %>%
  group_by(dsstox_substance_id) %>%
  summarise_if(is.numeric, min, na.rm=TRUE)

```

```{r, warning=FALSE}
asnm.tier1.all <- as.data.table(asnm.tier1.all)
# convert all Inf to NA
for (j in 1:ncol(asnm.tier1.all)) set(asnm.tier1.all, which(is.infinite(asnm.tier1.all[[j]])), j, NA)

```

* There's a few chemicals we just can't run

```{r, warning=FALSE}

dtxsids.aeds <- unique(asnm.tier1.all[,dsstox_substance_id])

apcra.list[!DTXSID %in% dtxsids.aeds]


```

## Determine substances for which steady state is a poor assumption

```{r, warning=FALSE}

for (this.chem in asnm.tier1.all$dsstox_substance_id)
{
  skip_to_next <- FALSE
  tryCatch(
  out <- calc_css(dtxsid = this.chem,
         species= 'Human',
            output.units = 'uM',
            daily.dose=1,
            doses.per.day=1,
            tissue = 'plasma',
            model = 'pbtk',
         f=0.001,
         adjusted.Funbound.plasma = TRUE,
            restrictive.clearance = TRUE,
            well.stirred.correction =TRUE),
  error = function(e) {skip_to_next <<-TRUE})
  if(skip_to_next){next}
  index <- asnm.tier1.all$dsstox_substance_id==this.chem
  asnm.tier1.all[index, "the.day"] <- out["the.day"] 
}

```



```{r, warning=FALSE, eval=FALSE, echo=FALSE}

for (i in pbtk.have$dsstox_substance_id){
#for (i in 1:nrow(asnm.tier1.all)) {
  
  skip_to_next <- FALSE
  tryCatch(
  css.out <- calc_css(dtxsid = pbtk.have$dsstox_substance_id[i],
                      species = 'Human',
                      output.units = 'uM',
                      daily.dose = 1,
                      default.to.human = TRUE,
                      doses.per.day = 1,
                      tissue = 'plasma',
                      model = 'pbtk',
                      adjusted.Funbound.plasma = TRUE,
                      well.stirred.correction = TRUE,
                      restrictive.clearance = TRUE,
                      f = 0.001,
                      suppress.messages = TRUE),
  
  error = function(e) {
    message(paste("CSS can't be found for: ", pbtk.have$dsstox_substance_id[i]))
    message("Here's the error message:")
    message(e)
    pbtk.have$the.day[i] <<- as.numeric(NA)
    skip_to_next <<- TRUE
    
  },
  warning = function(cond) {
    message(paste("calc_css caused a warning for: ", pbtk.have$dsstox_substance_id[i]))
    message("Here's the original warning message:")
    message(cond)
    pbtk.have[i] <<- as.numeric(NA)
    skip_to_next <<- TRUE
    
  })
  
  if(skip_to_next){next}
  pbtk.have$the.day[i] <- css.out$the.day
  
}


asnm.tier1.all$the.day <- pbtk.have$the.day[match(asnm.tier1.all$dsstox_substance_id,
                                                              pbtk.have$dsstox_substance_id)]
```








```{r deprecated-fxn-cssday, warning=FALSE, eval=FALSE, echo=FALSE}

for (this.chem in asnm.tier1.arith.pbtk$dsstox_substance_id)
{
  skip_to_next <- FALSE
  tryCatch(
  out <- calc_css(dtxsid = this.chem,
         species= 'Human',
            output.units = 'uM',
            daily.dose=1,
            doses.per.day=1,
            tissue = 'plasma',
            model = 'pbtk',
         f=0.001,
         adjusted.Funbound.plasma = TRUE,
            restrictive.clearance = TRUE,
            well.stirred.correction =TRUE),
  error = function(e) {
    message(paste("CSS can't be found for: ", asnm.tier1.arith.pbtk$dsstox_substance_id[i]))
    #message(paste("CSS can't be found for: ", this.chem[i]))
    message("Here's the error message:")
    message(e)
    asnm.tier1.arith.pbtk$the.day[i] <<- as.numeric(NA)
    skip_to_next <<-TRUE
    },
  warning = function(cond) {
    #message(paste("calc_css caused a warning for: ", asnm.tier1.arith.pbtk$dsstox_substance_id[i]))
    message(paste("calc_css caused a warning for: ", this.chem[i]))
    message("Here's the original warning message:")
    message(cond)
    asnm.tier1.arith.pbtk$the.day[i] <<- as.numeric(NA)
    skip_to_next <<- TRUE
})
  if(skip_to_next){next}
  index <- asnm.tier1.arith.pbtk$dsstox_substance_id==this.chem
  asnm.tier1.arith.pbtk[index, "Human.day.Css.pbtk"] <- out["the.day"] 
}

asnm.tier1.all$the.day <- asnm.tier1.arith.pbtk$the.day[match(asnm.tier1.all$dsstox_substance_id,
                                                              asnm.tier1.arith.pbtk$dsstox_substance_id)]

```

* 20 chemicals have a Css day > 90 days

```{r, warning=FALSE}

asnm.tier1.all[the.day>90]

```

## Create the ifelse to take the correct AED50

```{r, warning=FALSE}
asnm.tier1.all <- as.data.table(asnm.tier1.all)
asnm.tier1.all[ , aed50.atg := ifelse(!is.na(aed50.pbtk.atg), aed50.pbtk.atg, aed50.3compss.atg)]
asnm.tier1.all[ , aed50.bsk := ifelse(!is.na(aed50.pbtk.bsk), aed50.pbtk.bsk, aed50.3compss.bsk)]
asnm.tier1.all[ , aed50.ccte := ifelse(!is.na(aed50.pbtk.ccte), aed50.pbtk.ccte, aed50.3compss.ccte)]
asnm.tier1.all[ , aed50.nvs := ifelse(!is.na(aed50.pbtk.nvs), aed50.pbtk.nvs, aed50.3compss.nvs)]
asnm.tier1.all[ , aed50.stm := ifelse(!is.na(aed50.pbtk.stm), aed50.pbtk.stm, aed50.3compss.stm)]
asnm.tier1.all[ , aed50.httr.mcf7 := ifelse(!is.na(aed50.pbtk.httr.mcf7.sigbmd), aed50.pbtk.httr.mcf7.sigbmd, aed50.3compss.httr.mcf7.sigbmd)]
asnm.tier1.all[ , aed50.httr.u2os := ifelse(!is.na(aed50.pbtk.httr.u2os.sigbmd), aed50.pbtk.httr.u2os.sigbmd, aed50.3compss.httr.u2os.sigbmd)]
asnm.tier1.all[ , aed50.httr.heparg := ifelse(!is.na(aed50.pbtk.httr.heparg.sigbmd), aed50.pbtk.httr.heparg.sigbmd, aed50.3compss.httr.heparg.sigbmd)]
asnm.tier1.all[ , aed50.htpp.u2os := ifelse(!is.na(aed50.pbtk.htpp.u2os), aed50.pbtk.htpp.u2os, aed50.3compss.htpp.u2os)]
asnm.tier1.all[ , aed50.astar.beas2b := ifelse(!is.na(aed50.pbtk.astar.beas2b), aed50.pbtk.astar.beas2b, aed50.3compss.astar.beas2b)]
asnm.tier1.all[ , aed50.astar.hepg2 := ifelse(!is.na(aed50.pbtk.astar.hepg2), aed50.pbtk.astar.hepg2, aed50.3compss.astar.hepg2)]
asnm.tier1.all[ , aed50.astar.hek293 := ifelse(!is.na(aed50.pbtk.astar.hek293), aed50.pbtk.astar.hek293, aed50.3compss.astar.hek293)]
colnames(asnm.tier1.all)
```

## Add in ToxVal Summary values
I calculated different %-iles of ToxVal and we want to add them here.
First we clean up the %-iles of ToxVal data.
```{r, warning=FALSE}
# Ensure columns are numeric and also log10 transform the quantiles that were calculated
col.num <- c("apcra.ret.5p.POD", "p5.toxval.numeric","p10.toxval.numeric","p15.toxval.numeric","p20.toxval.numeric",    "p25.toxval.numeric","p30.toxval.numeric")
toxval.apcra.summary <- toxval.apcra.summary[, (col.num) := lapply(.SD, function(x) log10(x)), .SDcols = col.num ]

# Do the same procedure with the subchronic-only data
col.num <- c("p5.toxval.numeric.sub","p10.toxval.numeric.sub","p15.toxval.numeric.sub","p20.toxval.numeric.sub","p25.toxval.numeric.sub","p30.toxval.numeric.sub")
toxval.apcra.summary.subchronic <- toxval.apcra.summary.subchronic[, (col.num) := lapply(.SD, function(x) log10(x)), .SDcols = col.num ]

```

Here we merge the %-iles of ToxVal data with the AED values in a datatable called asnm.tier1.all.
```{r, warning=FALSE}

asnm.tier1.all <- merge.data.table(asnm.tier1.all,
                                    toxval.apcra.summary[,c("dtxsid",
                                                            "p5.toxval.numeric",
                                                            "p10.toxval.numeric",
                                                            "p15.toxval.numeric",
                                                            "p20.toxval.numeric",
                                                            "p25.toxval.numeric",
                                                            "p30.toxval.numeric"
                                                          )],
                                    by.x='dsstox_substance_id',
                                    by.y='dtxsid',
                                   all.x = TRUE)

asnm.tier1.all <- merge.data.table(asnm.tier1.all,
                                    toxval.apcra.summary.subchronic[,c("dtxsid",
                                                            "p5.toxval.numeric.sub",
                                                            "p10.toxval.numeric.sub",
                                                            "p15.toxval.numeric.sub",
                                                            "p20.toxval.numeric.sub",
                                                            "p25.toxval.numeric.sub",
                                                            "p30.toxval.numeric.sub"
                                                          )],
                                    by.x='dsstox_substance_id',
                                    by.y='dtxsid',
                                   all.x = TRUE)

asnm.tier1.all <- merge.data.table(asnm.tier1.all, 
                                   ad.tbl,
                                   by.x='dsstox_substance_id',
                                   by.y='DTXSID',
                                   all.x=TRUE)
colnames(asnm.tier1.all)
```

# Evaluating AEDs {.tabset .tabset-fade .tabset-pills}

## Baseline random forest model

```{r, warning=FALSE}

#dput(colnames(asnm.tier1.all))
# infer the median for the chemical for any missing (NA) data by giving median by row (median by chemical)
cols <- c("aed50.atg", 
"aed50.bsk", "aed50.ccte", "aed50.nvs", "aed50.stm", "aed50.httr.mcf7", 
"aed50.httr.u2os", "aed50.httr.heparg", "aed50.htpp.u2os", "aed50.astar.beas2b", 
"aed50.astar.hepg2", "aed50.astar.hek293")

asnm.tier1.all3 <- as.data.frame(asnm.tier1.all)

# replace NA by the median for each row
asnm.tier1.all3[cols] <- t(apply(asnm.tier1.all3[cols], 1, function(x)
  replace(x, is.na(x), median(x, na.rm=TRUE))))

asnm.tier1.pred3 <- as.data.table(asnm.tier1.all3)

asnm.tier1.pred3 <- asnm.tier1.pred3[!is.na(p5.toxval.numeric)]
asnm.tier1.pred3 <- asnm.tier1.pred3[!is.na(aed50.3compss.5pacc)]

```

## Random Forest in Caret for Prediction

```{r, warning=FALSE}
colnames(asnm.tier1.pred3)

```

There are 156 chemicals where we can actually compare to in vivo data from ToxVal in a "baseline" RF model for the AEDs by source.

### Using ToxVal POD 5th%-ile

```{r, warning=FALSE}
set.seed(1234567)

control <- trainControl(method='repeatedcv',
                        number=10,
                        repeats=3)

metric <- "Accuracy"

mtry <- sqrt(12)
tunegrid <- expand.grid(.mtry=mtry)

rf_aedtriage5 <- train(data=asnm.tier1.pred3[,c(29:41)],
                    p5.toxval.numeric~.,
                    method='rf',
                    metric='RMSE',
                    tunegrid=tunegrid,
                    trControl=control
                    )
print(rf_aedtriage5)
```
### Using ToxVal POD 10th%-ile

```{r, warning=FALSE}

control <- trainControl(method='repeatedcv',
                        number=10,
                        repeats=3)

metric <- "Accuracy"

mtry <- sqrt(12)
tunegrid <- expand.grid(.mtry=mtry)

rf_aedtriage10 <- train(data=asnm.tier1.pred3[,c(29:40, 42)],
                    p10.toxval.numeric~.,
                    method='rf',
                    metric='RMSE',
                    tunegrid=tunegrid,
                    trControl=control
                    )
print(rf_aedtriage10)

```

### Using ToxVal POD 15th%-ile

```{r, warning=FALSE}

control <- trainControl(method='repeatedcv',
                        number=10,
                        repeats=3)

metric <- "Accuracy"

mtry <- sqrt(12)
tunegrid <- expand.grid(.mtry=mtry)

rf_aedtriage15 <- train(data=asnm.tier1.pred3[,c(29:40, 43)],
                    p15.toxval.numeric~.,
                    method='rf',
                    metric='RMSE',
                    tunegrid=tunegrid,
                    trControl=control
                    )
print(rf_aedtriage15)

```

### Using ToxVal POD 20th%-ile

```{r, warning=FALSE}

control <- trainControl(method='repeatedcv',
                        number=10,
                        repeats=3)

metric <- "Accuracy"

mtry <- sqrt(12)
tunegrid <- expand.grid(.mtry=mtry)

rf_aedtriage20 <- train(data=asnm.tier1.pred3[,c(29:40, 44)],
                    p20.toxval.numeric~.,
                    method='rf',
                    metric='RMSE',
                    tunegrid=tunegrid,
                    trControl=control
                    )
print(rf_aedtriage20)

```

### Using ToxVal POD 25th%-ile

```{r, warning=FALSE}

control <- trainControl(method='repeatedcv',
                        number=10,
                        repeats=3,
                        savePredictions = TRUE)

metric <- "Accuracy"

mtry <- sqrt(12)
tunegrid <- expand.grid(.mtry=mtry)

rf_aedtriage25 <- train(data=asnm.tier1.pred3[,c(29:40, 45)],
                    p25.toxval.numeric~.,
                    method='rf',
                    metric='RMSE',
                    tunegrid=tunegrid,
                    trControl=control
                    )
print(rf_aedtriage25)

```

### Using ToxVal POD 30th%-ile

```{r, warning=FALSE}

control <- trainControl(method='repeatedcv',
                        number=10,
                        repeats=3)

metric <- "Accuracy"

mtry <- sqrt(12)
tunegrid <- expand.grid(.mtry=mtry)

rf_aedtriage30 <- train(data=asnm.tier1.pred3[,c(29:40, 46)],
                    p30.toxval.numeric~.,
                    method='rf',
                    metric='RMSE',
                    tunegrid=tunegrid,
                    trControl=control
                    )
print(rf_aedtriage30)

```

## Compare the minimum AED50 to ToxVal POD
* defining the minimum AED50 without CCTE-MEA does a little better on the whole

```{r, warning=FALSE}

#Calculate minimum of the minimum AED50 by source
asnm.tier1.pred3[,min.aed50 := min(aed50.atg, 
aed50.bsk, aed50.nvs, aed50.stm, aed50.httr.mcf7, 
aed50.httr.u2os, aed50.httr.heparg, aed50.htpp.u2os, aed50.astar.beas2b, 
aed50.astar.hepg2, aed50.astar.hek293, na.rm=TRUE), by=c('dsstox_substance_id')]

asnm.tier1.pred3[,min.aed50 := as.numeric(min.aed50)]

```

```{r, warning=FALSE}
# min AED vs toxval 5th %ile
aed.toxval5 <- lm(p5.toxval.numeric ~ min.aed50, 
            data= asnm.tier1.pred3)
summary(aed.toxval5)
#aed.toxval5.rmse <- round(sqrt(mean(aed.toxval5$residuals^2)),3)
#aed.toxval5.r2 <- round(summary(aed.toxval5)$r.squared,3)

# min AED vs toxval 10th %ile
aed.toxval10 <- lm(p10.toxval.numeric ~ min.aed50, 
            data= asnm.tier1.pred3)
summary(aed.toxval10)

# min AED vs toxval 15th %ile
aed.toxval15 <- lm(p15.toxval.numeric ~ min.aed50, 
            data= asnm.tier1.pred3)
summary(aed.toxval15)

# min AED vs toxval 20th %ile
aed.toxval20 <- lm(p20.toxval.numeric ~ min.aed50, 
            data= asnm.tier1.pred3)
summary(aed.toxval20)

# min AED vs toxval 25th %ile
aed.toxval25 <- lm(p25.toxval.numeric ~ min.aed50, 
            data= asnm.tier1.pred3)
summary(aed.toxval25)

# min AED vs toxval 30th %ile
aed.toxval30 <- lm(p30.toxval.numeric ~ min.aed50, 
            data= asnm.tier1.pred3)
summary(aed.toxval30)

```

## Median AED50 vs ToxVal PODs

Calculate the median AED50

```{r, warning=FALSE}
# Calculate median
asnm.tier1.pred3[,med.aed50 := median(aed50.atg, 
aed50.bsk, aed50.nvs, aed50.stm, aed50.httr.mcf7, 
aed50.httr.u2os, aed50.httr.heparg, aed50.htpp.u2os, aed50.astar.beas2b, 
aed50.astar.hepg2, aed50.astar.hek293, na.rm=TRUE), by=c('dsstox_substance_id')]

```

Compute model for different ToxVal PODs
First show med AED50 v 5th %ile POD

```{r, warning=FALSE}

# med AED vs toxval 5th %ile
aedmed.toxval5 <- lm(p5.toxval.numeric ~ med.aed50, 
            data= asnm.tier1.pred3)
summary(aedmed.toxval5)

# med AED vs toxval 10th %ile
aedmed.toxval10 <- lm(p10.toxval.numeric ~ med.aed50, 
            data= asnm.tier1.pred3)
#summary(aedmed.toxval10)

# med AED vs toxval 15th %ile
aedmed.toxval15 <- lm(p15.toxval.numeric ~ med.aed50, 
            data= asnm.tier1.pred3)
#summary(aedmed.toxval15)

# med AED vs toxval 20th %ile
aedmed.toxval20 <- lm(p20.toxval.numeric ~ med.aed50, 
            data= asnm.tier1.pred3)
#summary(aedmed.toxval20)

```
```{r, warning=FALSE}
# med AED vs toxval 25th %ile
aedmed.toxval25 <- lm(p25.toxval.numeric ~ med.aed50, 
            data= asnm.tier1.pred3)
summary(aedmed.toxval25)

# med AED vs toxval 30th %ile
aedmed.toxval30 <- lm(p30.toxval.numeric ~ med.aed50, 
            data= asnm.tier1.pred3)
summary(aedmed.toxval30)


```
### Adding calculation of broad NAMs min and med
Need to demonstrate combination of NAMs

```{r broad-summary-calcs, warning=FALSE}
# Calculate min broad

asnm.tier1.pred3[,min.aed50.broad := min(aed50.httr.mcf7, 
aed50.httr.u2os, aed50.httr.heparg, aed50.htpp.u2os, na.rm=TRUE), by=c('dsstox_substance_id')]

# Calculate med broad

asnm.tier1.pred3[,med.aed50.broad := median(aed50.httr.mcf7, 
aed50.httr.u2os, aed50.httr.heparg, aed50.htpp.u2os, na.rm=TRUE), by=c('dsstox_substance_id')]

# Calculate min targeted

asnm.tier1.pred3[,min.aed50.targeted := min(aed50.atg, 
aed50.bsk, aed50.nvs, aed50.stm, na.rm=TRUE), by=c('dsstox_substance_id')]

# Calculate med targeted

asnm.tier1.pred3[,med.aed50.targeted := median(aed50.atg, 
aed50.bsk, aed50.nvs, aed50.stm, na.rm=TRUE), by=c('dsstox_substance_id')]

```

Compute the broad median AED50s vs ToxVal %iles.

```{r broad-med-linear-comps, warning=FALSE}

# med AED broad vs toxval 5th %ile
aedmedbroad.toxval5 <- lm(p5.toxval.numeric ~ med.aed50.broad, 
            data= asnm.tier1.pred3)
summary(aedmedbroad.toxval5)

# med broad AED vs toxval 10th %ile
aedmedbroad.toxval10 <- lm(p10.toxval.numeric ~ med.aed50.broad, 
            data= asnm.tier1.pred3)

# med broad AED vs toxval 15th %ile
aedmedbroad.toxval15 <- lm(p15.toxval.numeric ~ med.aed50.broad, 
            data= asnm.tier1.pred3)

# med broad AED vs toxval 20th %ile
aedmedbroad.toxval20 <- lm(p20.toxval.numeric ~ med.aed50.broad, 
            data= asnm.tier1.pred3)

# med broad AED vs toxval 25th %ile
aedmedbroad.toxval25 <- lm(p25.toxval.numeric ~ med.aed50.broad, 
            data= asnm.tier1.pred3)

# med broad AED vs toxval 30th %ile
aedmedbroad.toxval30 <- lm(p30.toxval.numeric ~ med.aed50.broad, 
            data= asnm.tier1.pred3)

```

Compute the broad minimum AED50s vs ToxVal %iles.

```{r broad-min-linear-comps, warning=FALSE}

# min AED broad vs toxval 5th %ile
aedminbroad.toxval5 <- lm(p5.toxval.numeric ~ min.aed50.broad, 
            data= asnm.tier1.pred3)
summary(aedminbroad.toxval5)

# med broad AED vs toxval 10th %ile
aedminbroad.toxval10 <- lm(p10.toxval.numeric ~ min.aed50.broad, 
            data= asnm.tier1.pred3)

# med broad AED vs toxval 15th %ile
aedminbroad.toxval15 <- lm(p15.toxval.numeric ~ min.aed50.broad, 
            data= asnm.tier1.pred3)

# min broad AED vs toxval 20th %ile
aedminbroad.toxval20 <- lm(p20.toxval.numeric ~ min.aed50.broad, 
            data= asnm.tier1.pred3)

# min broad AED vs toxval 25th %ile
aedminbroad.toxval25 <- lm(p25.toxval.numeric ~ min.aed50.broad, 
            data= asnm.tier1.pred3)

# min broad AED vs toxval 30th %ile
aedminbroad.toxval30 <- lm(p30.toxval.numeric ~ min.aed50.broad, 
            data= asnm.tier1.pred3)

```

Compute the targeted median AED50s vs ToxVal %iles.

```{r targeted-med-linear-comps, warning=FALSE}

# med AED targeted vs toxval 5th %ile
aedmedtargeted.toxval5 <- lm(p5.toxval.numeric ~ med.aed50.targeted, 
            data= asnm.tier1.pred3)
summary(aedmedtargeted.toxval5)

# med targeted AED vs toxval 10th %ile
aedmedtargeted.toxval10 <- lm(p10.toxval.numeric ~ med.aed50.targeted, 
            data= asnm.tier1.pred3)

# med targeted AED vs toxval 15th %ile
aedmedtargeted.toxval15 <- lm(p15.toxval.numeric ~ med.aed50.targeted, 
            data= asnm.tier1.pred3)

# med targeted AED vs toxval 20th %ile
aedmedtargeted.toxval20 <- lm(p20.toxval.numeric ~ med.aed50.targeted, 
            data= asnm.tier1.pred3)

# med targeted AED vs toxval 25th %ile
aedmedtargeted.toxval25 <- lm(p25.toxval.numeric ~ med.aed50.targeted, 
            data= asnm.tier1.pred3)

# med targeted AED vs toxval 30th %ile
aedmedtargeted.toxval30 <- lm(p30.toxval.numeric ~ med.aed50.targeted, 
            data= asnm.tier1.pred3)

```

Compute the targeted minimum AED50s vs ToxVal %iles.

```{r targeted-min-linear-comps, warning=FALSE}

# min AED targeted vs toxval 5th %ile
aedmintargeted.toxval5 <- lm(p5.toxval.numeric ~ min.aed50.targeted, 
            data= asnm.tier1.pred3)
summary(aedmintargeted.toxval5)

# min targeted AED vs toxval 10th %ile
aedmintargeted.toxval10 <- lm(p10.toxval.numeric ~ min.aed50.targeted, 
            data= asnm.tier1.pred3)

# min targeted AED vs toxval 15th %ile
aedmintargeted.toxval15 <- lm(p15.toxval.numeric ~ min.aed50.targeted, 
            data= asnm.tier1.pred3)

# min targeted AED vs toxval 20th %ile
aedmintargeted.toxval20 <- lm(p20.toxval.numeric ~ min.aed50.targeted, 
            data= asnm.tier1.pred3)

# min targeted AED vs toxval 25th %ile
aedmintargeted.toxval25 <- lm(p25.toxval.numeric ~ min.aed50.targeted, 
            data= asnm.tier1.pred3)

# min targeted AED vs toxval 30th %ile
aedmintargeted.toxval30 <- lm(p30.toxval.numeric ~ min.aed50.targeted, 
            data= asnm.tier1.pred3)

```
Targeted NAMs individually


```{r targeted-individ-linear-comps, warning=FALSE}

# ATG vs toxval 5th %ile
aedatg.toxval5 <- lm(p5.toxval.numeric ~ aed50.atg, 
            data= asnm.tier1.pred3)

# BSK vs toxval 5th %ile
aedbsk.toxval5 <- lm(p5.toxval.numeric ~ aed50.bsk, 
            data= asnm.tier1.pred3)

# NVS vs toxval 5th %ile
aednvs.toxval5 <- lm(p5.toxval.numeric ~ aed50.nvs, 
            data= asnm.tier1.pred3)

# STM vs toxval 5th %ile
aedstm.toxval5 <- lm(p5.toxval.numeric ~ aed50.stm, 
            data= asnm.tier1.pred3)
```

Broad NAMs individually

```{r, warning=FALSE}

# HTPP U2-OS vs toxval 5th %ile
aedhtpp.toxval5 <- lm(p5.toxval.numeric ~ aed50.htpp.u2os, 
            data= asnm.tier1.pred3)

# HTTr U2-OS vs toxval 5th %ile
aedhttru2os.toxval5 <- lm(p5.toxval.numeric ~ aed50.httr.u2os, 
            data= asnm.tier1.pred3)

# HTTr MCF7 vs toxval 5th %ile
aedhttrmcf7.toxval5 <- lm(p5.toxval.numeric ~ aed50.httr.mcf7, 
            data= asnm.tier1.pred3)

# HTTr HepaRG vs toxval 5th %ile
aedhttrheparg.toxval5 <- lm(p5.toxval.numeric ~ aed50.httr.heparg, 
            data= asnm.tier1.pred3)

```

A*STAR individually

```{r, warning=FALSE}

# ASTAR BEAS-2B vs toxval 5th %ile
aedastarbeas2b.toxval5 <- lm(p5.toxval.numeric ~ aed50.astar.beas2b, 
            data= asnm.tier1.pred3)

# ASTAR HEPG2 vs toxval 5th %ile
aedastarhepg2.toxval5 <- lm(p5.toxval.numeric ~ aed50.astar.hepg2, 
            data= asnm.tier1.pred3)

# ASTAR HEK293 vs toxval 5th %ile
aedastarhek293.toxval5 <- lm(p5.toxval.numeric ~ aed50.astar.hek293, 
            data= asnm.tier1.pred3)

```


### MLR model for 5th%ile ToxVal

Make a simple MLR model that allows the AED50s by source to independently contribute to 5th %-ile ToxVal POD prediction.

```{r, warning=FALSE}
set.seed(123456)

model.aedtriage5.asnm <- lm(p5.toxval.numeric ~ 0
                 + aed50.atg
                 + aed50.bsk
                 + aed50.ccte
                 + aed50.nvs
                 + aed50.stm
                 + aed50.httr.mcf7
                 + aed50.httr.u2os
                 + aed50.httr.heparg
                 + aed50.htpp.u2os
                 + aed50.astar.beas2b
                 + aed50.astar.hepg2
                 + aed50.astar.hek293, data=asnm.tier1.pred3)
anova(model.aedtriage5.asnm)

```
Then evaluate the model and its assumptions.

```{r, warning=FALSE, fig.height=9,fig.width=7}
par(mfrow=c(3,2))
plot(model.aedtriage5.asnm, which=c(1,2,3,4,5))
```



```{r, warning=FALSE}
summary(model.aedtriage5.asnm)
sigma(model.aedtriage5.asnm)/mean(asnm.tier1.pred3$p5.toxval.numeric)
```
```{r, warning=FALSE}
coeff.tbl <- as.data.frame(model.aedtriage5.asnm$coefficients)
coeff.tbl$var_name <- row.names(coeff.tbl)
names(coeff.tbl)[1] <- "mlr_coeff"
coeff.tbl <- as.data.table(coeff.tbl)
```

```{r, warning=FALSE}
asnm.tier1.pred3[,mlr.aed50.toxval5 := (coeff.tbl[var_name=="aed50.atg"]$mlr_coeff)*aed50.atg 
                + (coeff.tbl[var_name=="aed50.bsk"]$mlr_coeff)*aed50.bsk
                 + (coeff.tbl[var_name=="aed50.ccte"]$mlr_coeff)*aed50.ccte
                 + (coeff.tbl[var_name=="aed50.nvs"]$mlr_coeff)*aed50.nvs
                 + (coeff.tbl[var_name=="aed50.stm"]$mlr_coeff)*aed50.stm
                 + (coeff.tbl[var_name=="aed50.httr.mcf7"]$mlr_coeff)*aed50.httr.mcf7
                 + (coeff.tbl[var_name=="aed50.httr.u2os"]$mlr_coeff)*aed50.httr.u2os
                 + (coeff.tbl[var_name=="aed50.httr.heparg"]$mlr_coeff)*aed50.httr.heparg
                 + (coeff.tbl[var_name=="aed50.htpp.u2os"]$mlr_coeff)*aed50.htpp.u2os
                 + (coeff.tbl[var_name=="aed50.astar.beas2b"]$mlr_coeff)*aed50.astar.beas2b
                 + (coeff.tbl[var_name=="aed50.astar.hepg2"]$mlr_coeff)*aed50.astar.hepg2
                 + (coeff.tbl[var_name=="aed50.astar.hek293"]$mlr_coeff)*aed50.astar.hek293] 

```

### MLR model for 25th%ile ToxVal

Create the linear model for the 25th %ile ToxVal POD.

```{r, warning=FALSE}
set.seed(123456)

model.aedtriage25.asnm <- lm(p25.toxval.numeric ~ 0
                 + aed50.atg
                 + aed50.bsk
                 + aed50.ccte
                 + aed50.nvs
                 + aed50.stm
                 + aed50.httr.mcf7
                 + aed50.httr.u2os
                 + aed50.httr.heparg
                 + aed50.htpp.u2os
                 + aed50.astar.beas2b
                 + aed50.astar.hepg2
                 + aed50.astar.hek293, data=asnm.tier1.pred3)
anova(model.aedtriage25.asnm)

```
Evaluate assumptions of the model.

```{r, warning=FALSE, fig.height=9,fig.width=7}
par(mfrow=c(3,2))
plot(model.aedtriage5.asnm, which=c(1,2,3,4,5))
```

Summarize the model.

```{r, warning=FALSE}
summary(model.aedtriage25.asnm)
sigma(model.aedtriage5.asnm)/mean(asnm.tier1.pred3$p25.toxval.numeric)
```

Build a coefficients table.

```{r, warning=FALSE}
coeff.tbl25 <- as.data.frame(model.aedtriage25.asnm$coefficients)
coeff.tbl25$var_name <- row.names(coeff.tbl25)
names(coeff.tbl25)[1] <- "mlr_coeff"
coeff.tbl25 <- as.data.table(coeff.tbl25)
```

Make the MLR prediction for the 25th %ile ToxVal POD using the model coefficients table.

```{r, warning=FALSE}
asnm.tier1.pred3[,mlr.aed50.toxval25 := (coeff.tbl25[var_name=="aed50.atg"]$mlr_coeff)*aed50.atg 
                + (coeff.tbl25[var_name=="aed50.bsk"]$mlr_coeff)*aed50.bsk
                 + (coeff.tbl25[var_name=="aed50.ccte"]$mlr_coeff)*aed50.ccte
                 + (coeff.tbl25[var_name=="aed50.nvs"]$mlr_coeff)*aed50.nvs
                 + (coeff.tbl25[var_name=="aed50.stm"]$mlr_coeff)*aed50.stm
                 + (coeff.tbl25[var_name=="aed50.httr.mcf7"]$mlr_coeff)*aed50.httr.mcf7
                 + (coeff.tbl25[var_name=="aed50.httr.u2os"]$mlr_coeff)*aed50.httr.u2os
                 + (coeff.tbl25[var_name=="aed50.httr.heparg"]$mlr_coeff)*aed50.httr.heparg
                 + (coeff.tbl25[var_name=="aed50.htpp.u2os"]$mlr_coeff)*aed50.htpp.u2os
                 + (coeff.tbl25[var_name=="aed50.astar.beas2b"]$mlr_coeff)*aed50.astar.beas2b
                 + (coeff.tbl25[var_name=="aed50.astar.hepg2"]$mlr_coeff)*aed50.astar.hepg2
                 + (coeff.tbl25[var_name=="aed50.astar.hek293"]$mlr_coeff)*aed50.astar.hek293] 
```

### Add in MLR predictions to the prediction table

```{r, warning=FALSE}
asnm.tier1.pred3[, mlr.pred5 := predict(model.aedtriage5.asnm, .SD), .SDcols = c(29:41)]
asnm.tier1.pred3[, mlr.pred25 := predict(model.aedtriage25.asnm, .SD), .SDcols = c(29:40,45)]
```

Calculate the RMSE and R2 on the MLR models.

```{r, warning=FALSE, echo=FALSE, eval=FALSE}
model.aedtriage5.asnm.rmse <- round(sqrt(mean(model.aedtriage5.asnm$residuals^2)),3)
model.aedtriage5.asnm.r2 <- round(summary(model.aedtriage5.asnm)$r.squared,3)

model.aedtriage25.asnm.rmse <- round(sqrt(mean(model.aedtriage25.asnm$residuals^2)),3)
model.aedtriage25.asnm.r2 <- round(summary(model.aedtriage25.asnm)$r.squared,3)

```

```{r, warning=FALSE}

mlr.eval5 <- lm(p5.toxval.numeric ~ mlr.pred5, 
            data= asnm.tier1.pred3)

model.aedtriage5.asnm.rmse <- round(sqrt(mean(mlr.eval5$residuals^2)),3)
model.aedtriage5.asnm.r2 <- round(summary(mlr.eval5)$r.squared,3)

mlr.eval25 <- lm(p25.toxval.numeric ~ mlr.pred25, 
            data= asnm.tier1.pred3)

model.aedtriage25.asnm.rmse <- round(sqrt(mean(mlr.eval25$residuals^2)),3)
model.aedtriage25.asnm.r2 <- round(summary(mlr.eval25)$r.squared,3)

mlr.eval25.toxval5 <- lm(p5.toxval.numeric ~ mlr.pred25, 
            data= asnm.tier1.pred3)

model.aedtriage25.toxval5.rmse <- round(sqrt(mean(mlr.eval25.toxval5$residuals^2)),3)
model.aedtriage25.toxval5.r2 <- round(summary(mlr.eval25.toxval5)$r.squared,3)

```

```{r, warning=FALSE}
mlr.eval5 <- lm(p5.toxval.numeric ~ mlr.pred5, 
            data= asnm.tier1.pred3)

model.aedtriage5.asnm.rmse <- round(sqrt(mean(mlr.eval5$residuals^2)),3)
model.aedtriage5.asnm.r2 <- round(summary(mlr.eval5)$r.squared,3)

mlr.eval25 <- lm(p25.toxval.numeric ~ mlr.pred25, 
            data= asnm.tier1.pred3)

model.aedtriage25.asnm.rmse <- round(sqrt(mean(mlr.eval25$residuals^2)),3)
model.aedtriage25.asnm.r2 <- round(summary(mlr.eval25)$r.squared,3)

```

Gutcheck: look at the distribution of values from the MLR models.

```{r, warning=FALSE}

ggplot(asnm.tier1.pred3)+
  geom_histogram(aes(x=asnm.tier1.pred3$mlr.pred5), fill='orange', alpha=0.2)+
  geom_histogram(aes(x=asnm.tier1.pred3$mlr.pred25), fill='blue', alpha=0.2)+
  theme_bw()+
  scale_x_continuous(breaks=seq(-2,6,1))+
  xlab("MLR Predicted POD, log10-mg/kg/day")+
  ylab("Frequency")
```

I tried adding in RF models for 5th and 25th percentile ToxVal POD.
However what you find is how inappropriate it is to use the RF model to predict the data it was trained on. The performance values are artificially inflated and not very meaningful.

```{r, warning=FALSE, eval=FALSE}

asnm.tier1.pred3[, rf.pred5 := predict(rf_aedtriage5, .SD), .SDcols = c(29:41)]
asnm.tier1.pred3[, rf.pred25 := predict(rf_aedtriage25, .SD), .SDcols = c(29:40,45)]
asnm.tier1.pred3[,c('rf.pred5',
                     'rf.pred25'):= NULL]
```

Add in the min and med of the broad and targeted NAMs to the predictions table.

```{r, warning=FALSE}
# Calculate median of targeted NAMs
asnm.tier1.pred3[,med.targeted.aed50 := median(aed50.atg, 
aed50.bsk, aed50.nvs, aed50.stm, na.rm=TRUE), by=c('dsstox_substance_id')]

# Calculate minimum of targeted NAMs
asnm.tier1.pred3[,min.targeted.aed50 := min(aed50.atg, 
aed50.bsk, aed50.nvs, aed50.stm, na.rm=TRUE), by=c('dsstox_substance_id')]

# Calculate median of broad NAMs
asnm.tier1.pred3[,med.broad.aed50 := median(aed50.httr.mcf7, 
aed50.httr.u2os, aed50.httr.heparg, aed50.htpp.u2os, na.rm=TRUE), by=c('dsstox_substance_id')]

# Calculate minimum of targeted NAMs
asnm.tier1.pred3[,min.broad.aed50 := min(aed50.httr.mcf7, 
aed50.httr.u2os, aed50.httr.heparg, aed50.htpp.u2os, na.rm=TRUE), by=c('dsstox_substance_id')]
```

# Visualization and Comparison {.tabset .tabset-fade .tabset-pills}

## AED50 by source VS. ToxVal PODs

Need longformat of all AED50 values by source and ToxVal PODs.
```{r, warning=FALSE}

asnm.tier1.pred3.long <- melt.data.table(asnm.tier1.pred3,
                                         id.vars = c('dsstox_substance_id',
                                                     'p5.toxval.numeric',
                                                     'p25.toxval.numeric',
                                                     'p5.toxval.numeric.sub',
                                                     'p25.toxval.numeric.sub'),
                                         measure.vars = c('aed50.atg', 
                                                          'aed50.bsk',
                                                          'aed50.ccte',
                                                          'aed50.nvs',
                                                          'aed50.stm',
                                                          'aed50.httr.mcf7',
                                                          'aed50.httr.u2os',
                                                          'aed50.httr.heparg',
                                                          'aed50.htpp.u2os',
                                                          'aed50.astar.beas2b',
                                                          'aed50.astar.hepg2',
                                                          'aed50.astar.hek293'),
                                         variable.name = c('aed50.type'),
                                         value.name = c('aed50'))

asnm.tier1.pred3.long <- melt.data.table(asnm.tier1.pred3.long,
                                         id.vars=c('dsstox_substance_id',
                                                   'aed50.type',
                                                   'aed50'),
                                         measure.vars=c('p5.toxval.numeric',
                                                     'p25.toxval.numeric',
                                                     'p5.toxval.numeric.sub',
                                                     'p25.toxval.numeric.sub'),
                                         variable.name=c('pod.type'),
                                         value.name = c('pod'))

```

```{r, warning=FALSE, fig.height=4, fig.width=7}

aed.asnm.lm <- ggplot(data=asnm.tier1.pred3.long[pod.type %in% c('p5.toxval.numeric','p25.toxval.numeric')], 
                 aes(x=aed50, y=pod, color=aed50.type))+
  geom_point(aes(x=aed50, y=pod, color=aed50.type), alpha=0.5, size=2)+
  scale_color_viridis(discrete=TRUE, name='AED50 Source')+
  scale_x_continuous(breaks=seq(-7, 5, 1))+
  scale_y_continuous(breaks=seq(-7, 5, 1))+
  coord_cartesian(xlim=c(-4,4), ylim=c(-4,4))+
  #coord_cartesian(xlim=c(0.0001, 10000000000), ylim=c(0.0000001, 10000000000))+
  theme_bw()+
  #geom_smooth(method='lm',se=FALSE,color='blue',formula=y~x)+
  #stat_poly_eq(formula=y ~x,
  #             eq.with.lhs = "y~`=`~",
  #             aes(label=paste0("atop(", ..eq.label.., ",", ..rr.label.., ")")),
  #             parse=TRUE)+
  geom_abline(color='black')+
  xlab('AED50, log10-mg/kg/day')+
  ylab('ToxVal POD, log10-mg/kg/day')+
   theme(axis.text = element_text(size=12),
        axis.title = element_text(size=14))+
  #geom_smooth(method='lm',se=FALSE,color='blue',formula=y~x)+
  #stat_poly_eq(formula=y ~x,
  #             eq.with.lhs = "italic(hat(y))~`=`~",
  #             aes(label=paste(..eq.label.., ..rr.label.., sep ="~~~")),
  #             parse=TRUE)+
  facet_wrap(~pod.type, scales='fixed')+
  theme(strip.background = element_rect(fill='white',size=1),
        strip.text = element_text(size=10, color='black',face='bold'))

aed.asnm.lm

```
## Min, Med, MLR, RF

Need longformat of all AED50 values by source and ToxVal PODs.
```{r, warning=FALSE}

asnm.tier1.pred3.long2 <- melt.data.table(asnm.tier1.pred3,
                                         id.vars = c('dsstox_substance_id',
                                                     'p5.toxval.numeric',
                                                     'p25.toxval.numeric'),
                                         measure.vars = c('min.aed50',
                                                          'med.aed50',
                                                          'mlr.pred5',
                                                          'mlr.pred25',
                                                          'min.targeted.aed50',
                                                          'min.broad.aed50',
                                                          'med.targeted.aed50',
                                                          'med.broad.aed50'),
                                         variable.name = c('model.type'),
                                         value.name = c('model.value'))

asnm.tier1.pred3.long2 <- melt.data.table(asnm.tier1.pred3.long2,
                                         id.vars=c('dsstox_substance_id',
                                                   'model.type',
                                                   'model.value'),
                                         measure.vars=c('p5.toxval.numeric',
                                                     'p25.toxval.numeric'),
                                         variable.name=c('pod.type'),
                                         value.name = c('pod'))

```

Add in RMSD calculation to augment RMSE and R2 from linear comparisons.

```{r rmsd-function, warning=FALSE}

rmsd <- function(x,y){
  # # check whether the length of the vectors being compared is different
  if(length(x)!=length(y)){
    stop("Length of x and y differ. Note elements should be matched pairs")
  }
  # obtain the difference between x and y
  d <- y - x
  # remove any cases where the difference is NA
  if(any(is.na(d))==TRUE){d <- d[-which(is.na(d))]}
  # obtain the root mean squared difference (RMSD)
  out <- sqrt(mean(d^2))
  # return the results
  return(out)
}
```

```{r, warning=FALSE}

rmsd.summary <- asnm.tier1.pred3 %>%
  dplyr::summarise(.data = .,
                   rmsd_p5_min = rmsd(min.aed50, p5.toxval.numeric),
                   rmsd_p10_min = rmsd(min.aed50, p10.toxval.numeric),
                   rmsd_p15_min = rmsd(min.aed50, p15.toxval.numeric),
                   rmsd_p20_min = rmsd(min.aed50, p20.toxval.numeric),
                   rmsd_p25_min = rmsd(min.aed50, p25.toxval.numeric),
                   rmsd_p30_min = rmsd(min.aed50, p30.toxval.numeric),
                   
                   rmsd_p5_med = rmsd(med.aed50, p5.toxval.numeric),
                   rmsd_p10_med = rmsd(med.aed50, p10.toxval.numeric),
                   rmsd_p15_med = rmsd(med.aed50, p15.toxval.numeric),
                   rmsd_p20_med = rmsd(med.aed50, p20.toxval.numeric),
                   rmsd_p25_med = rmsd(med.aed50, p25.toxval.numeric),
                   rmsd_p30_med = rmsd(med.aed50, p30.toxval.numeric),
                   
                   rmsd_p5_min_broad = rmsd(min.broad.aed50, p5.toxval.numeric),
                   rmsd_p10_min_broad = rmsd(min.broad.aed50, p10.toxval.numeric),
                   rmsd_p15_min_broad = rmsd(min.broad.aed50, p15.toxval.numeric),
                   rmsd_p20_min_broad = rmsd(min.broad.aed50, p20.toxval.numeric),
                   rmsd_p25_min_broad = rmsd(min.broad.aed50, p25.toxval.numeric),
                   rmsd_p30_min_broad = rmsd(min.broad.aed50, p30.toxval.numeric),
                   
                   rmsd_p5_min_targ = rmsd(min.targeted.aed50, p5.toxval.numeric),
                   rmsd_p10_min_targ = rmsd(min.targeted.aed50, p10.toxval.numeric),
                   rmsd_p15_min_targ = rmsd(min.targeted.aed50, p15.toxval.numeric),
                   rmsd_p20_min_targ = rmsd(min.targeted.aed50, p20.toxval.numeric),
                   rmsd_p25_min_targ = rmsd(min.targeted.aed50, p25.toxval.numeric),
                   rmsd_p30_min_targ = rmsd(min.targeted.aed50, p30.toxval.numeric),
                   
                   rmsd_p5_med_broad = rmsd(med.broad.aed50, p5.toxval.numeric),
                   rmsd_p10_med_broad = rmsd(med.broad.aed50, p10.toxval.numeric),
                   rmsd_p15_med_broad = rmsd(med.broad.aed50, p15.toxval.numeric),
                   rmsd_p20_med_broad = rmsd(med.broad.aed50, p20.toxval.numeric),
                   rmsd_p25_med_broad = rmsd(med.broad.aed50, p25.toxval.numeric),
                   rmsd_p30_med_broad = rmsd(med.broad.aed50, p30.toxval.numeric),
                   
                   rmsd_p5_med_targ = rmsd(med.targeted.aed50, p5.toxval.numeric),
                   rmsd_p10_med_targ = rmsd(med.targeted.aed50, p10.toxval.numeric),
                   rmsd_p15_med_targ = rmsd(med.targeted.aed50, p15.toxval.numeric),
                   rmsd_p20_med_targ = rmsd(med.targeted.aed50, p20.toxval.numeric),
                   rmsd_p25_med_targ = rmsd(med.targeted.aed50, p25.toxval.numeric),
                   rmsd_p30_med_targ = rmsd(med.targeted.aed50, p30.toxval.numeric),
                   
                   rmsd_p5_atg = rmsd(aed50.atg, p5.toxval.numeric),
                   rmsd_p5_bsk = rmsd(aed50.bsk, p5.toxval.numeric),
                   rmsd_p5_nvs = rmsd(aed50.nvs, p5.toxval.numeric),
                   rmsd_p5_stm = rmsd(aed50.stm, p5.toxval.numeric),
                   
                   rmsd_p5_htpp_u2os = rmsd(aed50.htpp.u2os, p5.toxval.numeric),
                   rmsd_p5_httr_heparg = rmsd(aed50.httr.heparg, p5.toxval.numeric),
                   rmsd_p5_httr_mcf7 = rmsd(aed50.httr.mcf7, p5.toxval.numeric),
                   rmsd_p5_httr_u2os = rmsd(aed50.httr.u2os, p5.toxval.numeric),
                   
                   rmsd_p5_astar_beas2b = rmsd(aed50.astar.beas2b, p5.toxval.numeric),
                   rmsd_p5_astar_hek293 = rmsd(aed50.astar.hek293, p5.toxval.numeric),
                   rmsd_p5_astar_hepg2 = rmsd(aed50.astar.hepg2, p5.toxval.numeric),
                   
                   rmsd_p5_mlr5 = rmsd(mlr.aed50.toxval5, p5.toxval.numeric),
                   rmsd_p25_mlr25 = rmsd(mlr.aed50.toxval25, p25.toxval.numeric)
                   )

rmsd.summary <-  t(rmsd.summary) %>% as.data.frame()
rmsd.summary <- rownames_to_column(rmsd.summary, var="RMSD type")
rmsd.summary <- rename(rmsd.summary, RMSD = V1)

rmsd.summary
```

Create a summary table of model with R2 and RMSE.
Modified significantly at R1 to add in more models and more easily calculate RMSE and R2.

```{r, warning=FALSE}

# develop model list for functions

model_list <- list(
          # battery min models
          aed.toxval5,
          aed.toxval10,
          aed.toxval15,
          aed.toxval20,
          aed.toxval25,
          aed.toxval30,
          
          # battery med models
          aedmed.toxval5,
          aedmed.toxval10,
          aedmed.toxval15,
          aedmed.toxval20,
          aedmed.toxval25,
          aedmed.toxval30,
          
          # min broad battery
          aedminbroad.toxval5,
          aedminbroad.toxval10,
          aedminbroad.toxval15,
          aedminbroad.toxval20,
          aedminbroad.toxval25,
          aedminbroad.toxval30,
          
          # min targeted battery
          aedmintargeted.toxval5,
          aedmintargeted.toxval10,
          aedmintargeted.toxval15,
          aedmintargeted.toxval20,
          aedmintargeted.toxval25,
          aedmintargeted.toxval30,
          
          # med broad battery
          aedmedbroad.toxval5,
          aedmedbroad.toxval10,
          aedmedbroad.toxval15,
          aedmedbroad.toxval20,
          aedmedbroad.toxval25,
          aedmedbroad.toxval30,
          
          # med targeted battery
          aedmedtargeted.toxval5,
          aedmedtargeted.toxval10,
          aedmedtargeted.toxval15,
          aedmedtargeted.toxval20,
          aedmedtargeted.toxval25,
          aedmedtargeted.toxval30,
          
          # individ assay models
          aedatg.toxval5,
          aedbsk.toxval5,
          aednvs.toxval5,
          aedstm.toxval5,
          
          aedhtpp.toxval5,
          aedhttrheparg.toxval5,
          aedhttrmcf7.toxval5,
          aedhttru2os.toxval5,
          
          aedastarbeas2b.toxval5,
          aedastarhek293.toxval5,
          aedastarhepg2.toxval5,
          
          
          # battery mlr models
          mlr.eval5,
          mlr.eval25,
          mlr.eval25.toxval5)


# function to calculate RMSE

model_list_rmse <- function(model) {
  round(sqrt(mean(model$residuals^2)),3)
}

# function to calculate R-squared

model_list_r2 <- function(model) {
  round(summary(model)$r.squared,3)
}

# apply rmse and r2 functions to list

models_rmse <- model_list %>% {
  tibble(rmse = map_dbl(., model_list_rmse))}

models_r2 <- model_list %>% {
  tibble(r2 = map_dbl(., model_list_r2))}

```

```{r, warning=FALSE}
# add in model name
models_names <- c('min AED50',
                'min AED50',
                'min AED50',
                'min AED50',
                'min AED50',
                'min AED50',
                'med AED50',
                'med AED50',
                'med AED50',
                'med AED50',
                'med AED50',
                'med AED50',
                
                # adding for R1: broad vs targeted parts of the battery
                'min AED50, broad',
                'min AED50, broad',
                'min AED50, broad',
                'min AED50, broad',
                'min AED50, broad',
                'min AED50, broad',
                'min AED50, targeted',
                'min AED50, targeted',
                'min AED50, targeted',
                'min AED50, targeted',
                'min AED50, targeted',
                'min AED50, targeted',
                
                'med AED50, broad',
                'med AED50, broad',
                'med AED50, broad',
                'med AED50, broad',
                'med AED50, broad',
                'med AED50, broad',
                'med AED50, targeted',
                'med AED50, targeted',
                'med AED50, targeted',
                'med AED50, targeted',
                'med AED50, targeted',
                'med AED50, targeted',
                
                # adding for R1: each assay technology in isolation
                'ATG AED50', #1
                'BSK AED50', #2
                'NVS AED50', #3
                'STM AED50', #4
                'HTPP U2-OS AED50', #5
                
                'HTTr HepaRG AED50',#6
                'HTTr MCF7 AED50',#7
                'HTTr U2-OS AED50',#8
                
                'ASTAR BEAS-2B AED50', #9
                'ASTAR HepG2 AED50',#10
                'ASTAR HK-2 AED50',#11
                
                'mlr AED50 trained to ToxVal5',
                'mlr AED50 trained to ToxVal25',
                'mlr AED50 trained to ToxVal25 eval ToxVal5' )


```

```{r, warning=FALSE}
pod.type <- c('ToxVal 5th%ile', # min battery
              'ToxVal 10th%ile',
              'ToxVal 15th%ile',
              'ToxVal 20th%ile',
              'ToxVal 25th%ile',
              'ToxVal 30th%ile',
              
              'ToxVal 5th%ile', # med battery
              'ToxVal 10th%ile',
              'ToxVal 15th%ile',
              'ToxVal 20th%ile',
              'ToxVal 25th%ile',
              'ToxVal 30th%ile',
              
              'ToxVal 5th%ile', # min broad
              'ToxVal 10th%ile',
              'ToxVal 15th%ile',
              'ToxVal 20th%ile',
              'ToxVal 25th%ile',
              'ToxVal 30th%ile',
              
              'ToxVal 5th%ile', # min targeted
              'ToxVal 10th%ile',
              'ToxVal 15th%ile',
              'ToxVal 20th%ile',
              'ToxVal 25th%ile',
              'ToxVal 30th%ile',
              
              'ToxVal 5th%ile', # med broad
              'ToxVal 10th%ile',
              'ToxVal 15th%ile',
              'ToxVal 20th%ile',
              'ToxVal 25th%ile',
              'ToxVal 30th%ile',
              
              'ToxVal 5th%ile', # med targeted
              'ToxVal 10th%ile',
              'ToxVal 15th%ile',
              'ToxVal 20th%ile',
              'ToxVal 25th%ile',
              'ToxVal 30th%ile',
              
              'ToxVal 5th%ile', #1
              'ToxVal 5th%ile', #2
              'ToxVal 5th%ile', #3
              'ToxVal 5th%ile',#4
              'ToxVal 5th%ile',#5
              'ToxVal 5th%ile',#6
              'ToxVal 5th%ile',#7
              'ToxVal 5th%ile',#8
              'ToxVal 5th%ile',#9
              'ToxVal 5th%ile',#10
              'ToxVal 5th%ile',#11
             
               'ToxVal 5th%ile',
              'ToxVal 25th%ile',
              'ToxVal 5th%ile'
              
              )

```

Bind all and neaten the dataframe

```{r, warning=FALSE}
# bind
rmsd.summary <- rbind(rmsd.summary, c('mlr_toxval25_vp5', NA))
models_performance_summary <- as.data.table(bind_cols(models_rmse, models_r2, rmsd.summary, models_names, pod.type))

setcolorder(models_performance_summary, c('...5','...6','rmse','r2','RMSD','RMSD type'))
setnames(models_performance_summary, c('...5','...6','rmse','r2'), c('Model Type', 'POD Type','RMSE','R2'))

models_performance_summary[,RMSD := as.numeric(RMSD)]
models_performance_summary[, RMSD := round(RMSD,3)]
models_performance_summary
```

Here we write the final models performance table.
```{r, warning=FALSE}
# from rf_aedtriage5
rf_mod_toxval5 <- t(as.data.frame(c('rf AED50','ToxVal 5th%ile',1.273,0.171,NA,NA)))
# from rf_aedtriage25
rf_mod_toxval25 <- t(as.data.frame(c('rf AED50','ToxVal 25th%ile',1.031,0.206,NA,NA)))

models_performance_summary <- rbind(models_performance_summary,
                                    rf_mod_toxval5,
                                    rf_mod_toxval25,
                                    use.names=FALSE)

#write.csv(models_performance_summary, './output/Table2_models_performance_summary_27nov2024.csv')

```

This next part is a summary visualization of some of the models for the paper.

```{r, warning=FALSE, fig.height=4, fig.width=9}

# new facet labels
model.labels <- c('Min AED50',
                  'Med AED50',
                  'MLR AED50 : ToxVal 25th%ile')
names(model.labels) <- c('min.aed50','med.aed50','mlr.pred25')


aed.model.lm <- ggplot(data=asnm.tier1.pred3.long2[pod.type %in% c('p5.toxval.numeric', 
                                                                   'p25.toxval.numeric')
                                                   & model.type %in% c('min.aed50',
                                                                       'med.aed50',
                                                                       'mlr.pred25')], 
                 aes(x=model.value, 
                     y=pod, 
                     color=pod.type, shape=pod.type))+
  geom_point(aes(x=model.value, 
                 y=pod, 
                 color=pod.type, shape=pod.type), alpha=0.7, size=2)+
  scale_color_manual(name='POD Type',
                     values=c('#481567FF','#95D840FF'),
                     labels=c('ToxVal 5th%ile', 'ToxVal 25th%ile'),
                     breaks = c('p5.toxval.numeric',
                                'p25.toxval.numeric'))+
  scale_shape_manual(name='POD Type',
                     values=c(15,17),
                     labels=c('ToxVal 5th%ile', 'ToxVal 25th%ile'),
                     breaks = c('p5.toxval.numeric',
                                'p25.toxval.numeric'))+
  scale_x_continuous(breaks=seq(-7, 5, 1))+
  scale_y_continuous(breaks=seq(-7, 5, 1))+
  coord_cartesian(xlim=c(-4,4), ylim=c(-4,4))+
  theme_bw()+
  geom_smooth(aes(group=pod.type), method='lm',se=FALSE,formula=y~x)+
  stat_poly_eq(
               formula=y ~x,
               #eq.with.lhs = "y~`=`~",
               aes(label=paste0("atop(",..rr.label..,")")),
               parse=TRUE,
               #label.x=c(rep('right',3), 'left'),
               label.y=c(-2,-4),
               label.x=c(-3,1),
               size=5, face='bold')+
  geom_abline(slope=1, intercept=0) +
  geom_abline(slope=1, intercept=1, linetype="dashed") +
  geom_abline(slope=1, intercept=-1, linetype="dashed") +
  xlab('AED50, log10-mg/kg/day')+
  ylab('ToxVal POD, log10-mg/kg/day')+
   theme(axis.text = element_text(size=12),
        axis.title = element_text(size=14))+
  facet_wrap(~model.type, scales='fixed', labeller = labeller(model.type=model.labels))+
  theme(strip.background = element_rect(fill='white',size=1),
        strip.text = element_text(size=10, color='black',face='bold'))

aed.model.lm

```
For R1, adding targeted and broad min and med.

```{r, warning=FALSE, fig.height=4, fig.width=12}

# new facet labels
model.labels <- c('Min Broad',
                  'Min Targeted',
                  'Med Broad',
                  'Med Targeted')
names(model.labels) <- c('min.broad.aed50','min.targeted.aed50','med.broad.aed50','med.targeted.aed50')

# main plot
aed.model.broadvtarget <- ggplot(data=asnm.tier1.pred3.long2[pod.type %in% c('p5.toxval.numeric', 
                                                                   'p25.toxval.numeric')
                                                   & model.type %in% c('min.broad.aed50','min.targeted.aed50',
                                                                       'med.broad.aed50', 'med.targeted.aed50')], 
                 aes(x=model.value, 
                     y=pod, 
                     color=pod.type, shape=pod.type))+
  geom_point(aes(x=model.value, 
                 y=pod, 
                 color=pod.type, shape=pod.type), alpha=0.7, size=2)+
  scale_color_manual(name='POD Type',
                     values=c('#481567FF','#95D840FF'),
                     labels=c('ToxVal 5th%ile', 'ToxVal 25th%ile'),
                     breaks = c('p5.toxval.numeric',
                                'p25.toxval.numeric'))+
  scale_shape_manual(name='POD Type',
                     values=c(15,17),
                     labels=c('ToxVal 5th%ile', 'ToxVal 25th%ile'),
                     breaks = c('p5.toxval.numeric',
                                'p25.toxval.numeric'))+
  scale_x_continuous(breaks=seq(-7, 5, 1))+
  scale_y_continuous(breaks=seq(-7, 5, 1))+
  coord_cartesian(xlim=c(-4,4), ylim=c(-4,4))+
  theme_bw()+
  geom_smooth(aes(group=pod.type), method='lm',se=FALSE,formula=y~x)+
  stat_poly_eq(
               formula=y ~x,
               #eq.with.lhs = "y~`=`~",
               aes(label=paste0("atop(",..rr.label..,")")),
               parse=TRUE,
               #label.x=c(rep('right',3), 'left'),
               label.y=c(-2,-4),
               label.x=c(-3,1),
               size=5, face='bold')+
  geom_abline(slope=1, intercept=0) +
  geom_abline(slope=1, intercept=1, linetype="dashed") +
  geom_abline(slope=1, intercept=-1, linetype="dashed") +
  xlab('AED50, log10-mg/kg/day')+
  ylab('ToxVal POD, log10-mg/kg/day')+
   theme(axis.text = element_text(size=12),
        axis.title = element_text(size=14))+
  facet_wrap(~model.type, scales='fixed', labeller = labeller(model.type=model.labels), nrow=1, ncol=4)+
  theme(strip.background = element_rect(fill='white',size=1),
        strip.text = element_text(size=10, color='black',face='bold'))

aed.model.broadvtarget

```

```{r, warning=FALSE, fig.width=14, fig.height=14}

fig.PODNAM <- plot_grid(aed.asnm.lm,
                        aed.model.lm, 
                        aed.model.broadvtarget,
                        labels=c("A","B", "C"),
                        label_size=18,
                        nrow=3,
                        #align='v',
                        #rel_widths = c(1,2),
                        #rel_heights = c(1,1),
                        scale=c(0.8,1,1))

fig.PODNAM

```

```{r, warning=FALSE, eval=FALSE}

file.dir <- paste('output/', sep='')
file.name <- paste('/Fig_PODNAM_derivation_', Sys.Date(), '.tiff', sep='')
file.path <- paste(file.dir, file.name, sep='')
dir.create(path=file.dir, showWarnings = FALSE, recursive = TRUE)
tiff(file.path, width=10, height=14, units='in', res=450)
plot_grid(aed.asnm.lm,
                        aed.model.lm, 
                        aed.model.broadvtarget,
                        labels=c("A","B", "C"),
                        label_size=18,
                        nrow=3,
                        align='v',
                        #rel_widths = c(1,2),
                        #rel_heights = c(1,1),
                        scale=c(0.8,1,1))
dev.off()

```

# Putting together the data sheet {.tabset .tabset-fade .tabset-pills}

Add summary columns to dataframe

```{r, warning=FALSE}
colnames(asnm.tier1.all)
```

```{r, warning=FALSE}
# add in the MLR Results

asnm.tier1.all[,mlr.toxval5.aed50 := sum((coeff.tbl25[var_name=="aed50.atg"]$mlr_coeff)*aed50.atg 
                + (coeff.tbl25[var_name=="aed50.bsk"]$mlr_coeff)*aed50.bsk
                 + (coeff.tbl25[var_name=="aed50.ccte"]$mlr_coeff)*aed50.ccte
                 + (coeff.tbl25[var_name=="aed50.nvs"]$mlr_coeff)*aed50.nvs
                 + (coeff.tbl25[var_name=="aed50.stm"]$mlr_coeff)*aed50.stm
                 + (coeff.tbl25[var_name=="aed50.httr.mcf7"]$mlr_coeff)*aed50.httr.mcf7
                 + (coeff.tbl25[var_name=="aed50.httr.u2os"]$mlr_coeff)*aed50.httr.u2os
                 + (coeff.tbl25[var_name=="aed50.httr.heparg"]$mlr_coeff)*aed50.httr.heparg
                 + (coeff.tbl25[var_name=="aed50.htpp.u2os"]$mlr_coeff)*aed50.htpp.u2os
                 + (coeff.tbl25[var_name=="aed50.astar.beas2b"]$mlr_coeff)*aed50.astar.beas2b
                 + (coeff.tbl25[var_name=="aed50.astar.hepg2"]$mlr_coeff)*aed50.astar.hepg2
                 + (coeff.tbl25[var_name=="aed50.astar.hek293"]$mlr_coeff)*aed50.astar.hek293, na.rm=TRUE), by=c('dsstox_substance_id')]

asnm.tier1.all[,mlr.toxval25.aed50 := sum((coeff.tbl25[var_name=="aed50.atg"]$mlr_coeff)*aed50.atg 
                + (coeff.tbl25[var_name=="aed50.bsk"]$mlr_coeff)*aed50.bsk
                 + (coeff.tbl25[var_name=="aed50.ccte"]$mlr_coeff)*aed50.ccte
                 + (coeff.tbl25[var_name=="aed50.nvs"]$mlr_coeff)*aed50.nvs
                 + (coeff.tbl25[var_name=="aed50.stm"]$mlr_coeff)*aed50.stm
                 + (coeff.tbl25[var_name=="aed50.httr.mcf7"]$mlr_coeff)*aed50.httr.mcf7
                 + (coeff.tbl25[var_name=="aed50.httr.u2os"]$mlr_coeff)*aed50.httr.u2os
                 + (coeff.tbl25[var_name=="aed50.httr.heparg"]$mlr_coeff)*aed50.httr.heparg
                 + (coeff.tbl25[var_name=="aed50.htpp.u2os"]$mlr_coeff)*aed50.htpp.u2os
                 + (coeff.tbl25[var_name=="aed50.astar.beas2b"]$mlr_coeff)*aed50.astar.beas2b
                 + (coeff.tbl25[var_name=="aed50.astar.hepg2"]$mlr_coeff)*aed50.astar.hepg2
                 + (coeff.tbl25[var_name=="aed50.astar.hek293"]$mlr_coeff)*aed50.astar.hek293, na.rm=TRUE), by=c('dsstox_substance_id')]
```

```{r, warning=FALSE}

# take median (no ccte MEA)
asnm.tier1.all <- asnm.tier1.all %>% rowwise() %>% mutate(med.aed50=median(c(aed50.atg, 
aed50.bsk, aed50.nvs, aed50.stm, aed50.httr.mcf7, 
aed50.httr.u2os, aed50.httr.heparg, aed50.htpp.u2os, aed50.astar.beas2b, 
aed50.astar.hepg2, aed50.astar.hek293),na.rm=TRUE)) %>% data.table()

# take minimum, no ccte (no MEA)
asnm.tier1.all <- asnm.tier1.all %>% rowwise() %>% mutate(min.aed50=min(c(aed50.atg, 
aed50.bsk, aed50.nvs, aed50.stm, aed50.httr.mcf7, 
aed50.httr.u2os, aed50.httr.heparg, aed50.htpp.u2os, aed50.astar.beas2b, 
aed50.astar.hepg2, aed50.astar.hek293), na.rm=TRUE)) %>% data.table()

# median of targeted NAMs (no CCTE - no MEA)
asnm.tier1.all <- asnm.tier1.all %>% rowwise() %>% mutate(med.targeted.aed50=median(c(aed50.atg, 
aed50.bsk, aed50.nvs, aed50.stm),na.rm=TRUE)) %>% data.table()

# minimum of targeted NAMs
asnm.tier1.all <- asnm.tier1.all %>% rowwise() %>% mutate(min.targeted.aed50=min(c(aed50.atg, 
aed50.bsk, aed50.nvs, aed50.stm),na.rm=TRUE)) %>% data.table()

# median of broad profiling
asnm.tier1.all <- asnm.tier1.all %>% rowwise() %>% mutate(med.broad.aed50=median(c(aed50.httr.mcf7, 
aed50.httr.u2os, aed50.httr.heparg, aed50.htpp.u2os),na.rm=TRUE)) %>% data.table()

# minimum of broad profiling
asnm.tier1.all<- asnm.tier1.all %>% rowwise() %>% mutate(min.broad.aed50=min(c(aed50.httr.mcf7, 
aed50.httr.u2os, aed50.httr.heparg),na.rm=TRUE)) %>% data.table()


```

```{r, warning=FALSE, eval=FALSE}

# for input to hazard flag and BER calculation

save(asnm.tier1.pred3, asnm.tier1.all, file= './output/aed_tbl_Nov2024.RData')

```

```{r, warning=FALSE}

load(file= './output/aed_tbl_Nov2024.RData')
```

# Load In vivo Data {.tabset .tabset-fade .tabset-pills}

## ECHA POD Information

```{r, warning=FALSE}

echa.repdose <- read.xlsx('./source/in_vivo/draft_apcra_pro_selection_tbl_9_Feb_2023_InVivo_screening.xlsx', sheet=3, colNames = TRUE) %>% data.table()
```

```{r, warning=FALSE}
echa.systemic <- as.data.table(echa.repdose)
header.true <- function(df) {
  names(df) <- as.character(unlist(df[1,]))
  df[-1,]
}
echa.systemic <- header.true(echa.systemic)

echa.systemic <- echa.systemic[,c('chnm','dsstox_substance_id',
                                  'data poor - no repeat dose toxicity data on the substance / no plans',
                                  'Katie_quant_dose_lowest_LOAEL_mkd',
                                  'Katie_quant_dose_lowest_NOAEL_mkd',
                                  'Katie_422_syst_LOAEL_mkd',                                                         'Katie_422_syst_NOAEL_mkd')]

colnames(echa.systemic)


```

```{r, warning=FALSE}

setnames(echa.systemic, names(echa.systemic), c('chnm','dsstox_substance_id','data_poor_notes',
                                                'OECD_407_408_LOAEL_mkd','OECD_407_408_NOAEL_mkd',
                                                'OECD_422syst_LOAEL_mkd','OECD_422syst_NOAEL_mkd'))

```

```{r, warning=FALSE}

echa.systemic[grep('no', data_poor_notes), data_poor_binary := 0]
echa.systemic[grep('data generation', data_poor_notes), data_poor_binary := 0]
# what does it mean if there's no note? Data poor?
echa.systemic[is.na(data_poor_notes), data_poor_binary := 1]
echa.systemic[grep('yes',data_poor_notes), data_poor_binary := 1]
head(echa.systemic)

```

```{r, warning=FALSE}
change_cols <- c('OECD_407_408_LOAEL_mkd','OECD_407_408_NOAEL_mkd',
                                                'OECD_422syst_LOAEL_mkd','OECD_422syst_NOAEL_mkd')
echa.systemic[, (change_cols) := lapply(.SD, as.numeric), .SDcols = change_cols]
echa.systemic[, ECHA_min_systemic_POD_mkd := min(OECD_407_408_LOAEL_mkd,OECD_407_408_NOAEL_mkd,
                                                OECD_422syst_LOAEL_mkd,OECD_422syst_NOAEL_mkd, na.rm=TRUE), by=chnm]
echa.systemic[, ECHA_min_systemic_POD_mkd := lapply(.SD, as.numeric), .SDcols = 'ECHA_min_systemic_POD_mkd']

for (j in 1:ncol(echa.systemic)) set(echa.systemic, which(is.infinite(echa.systemic[[j]])), j, NA)
```

```{r, warning=FALSE}

nrow(echa.systemic[!is.na(ECHA_min_systemic_POD_mkd)])


```
## ToxVal PODs
+ Load ToxVal
+ See how many we have for each type of ToxVal and ECHA data
+ show performance in multiple panels

```{r, warning=FALSE}

load('./source/in_vivo/apcra_pro_toxval_v9_4_PODs.RData')

```

```{r, warning=FALSE}

toxval.all <- merge.data.table(toxval.apcra.summary, 
                               toxval.apcra.summary.subchronic,
                               all.x=TRUE, all.y = TRUE, by=c('dtxsid'))

toxval.all <- merge.data.table(toxval.all,
                               apcra.list[,c('DTXSID', 'CASRN', 'preferred_name')],
                               all.x=TRUE,
                               all.y=TRUE,
                               by.x=c('dtxsid'),
                               by.y=c('DTXSID'))

setnames(toxval.all, c('dtxsid'), c('dsstox_substance_id'))

invivo.all <- merge.data.table(toxval.all,echa.systemic,
                               all.x=TRUE, 
                               all.y=TRUE, 
                               by =c('dsstox_substance_id'))

invivo.all <- invivo.all[!is.na(dsstox_substance_id)]

```

```{r, warning=FALSE}

#invivo.all[is.na(CASRN)]
invivo.all[,c('casrn.x','name.x','chnm','name.y','casrn.y') := NULL]
setcolorder(invivo.all, c(1,29:30,2:28,31:37))
colnames(invivo.all)
```


```{r, warning=FALSE}
kable(invivo.all,
           filter='top', 
          options=list(pagelength=25, autoWidth=FALSE,  scrollX=TRUE, initComplete = JS(
    "function(settings, json) {",
    "$('body').css({'font-family': 'Calibri'});",
    "}"
  )))
```

Make all units log10-mg/kg/day
```{r, warning=FALSE}
# ECHA data
invivo.all[, log.ECHA_min_systemic_POD_mkd := log10(ECHA_min_systemic_POD_mkd)]

# Toxval 
invivo.all[, p5.toxval.numeric := log10(p5.toxval.numeric)]
invivo.all[, p10.toxval.numeric := log10(p10.toxval.numeric)]
invivo.all[, p15.toxval.numeric := log10(p15.toxval.numeric)]
invivo.all[, p20.toxval.numeric := log10(p20.toxval.numeric)]
invivo.all[, p25.toxval.numeric := log10(p25.toxval.numeric)]
invivo.all[, p30.toxval.numeric := log10(p30.toxval.numeric)]

# ToxVal - subchronic only
invivo.all[, p5.toxval.numeric.sub := log10(p5.toxval.numeric.sub)]
invivo.all[, p10.toxval.numeric.sub := log10(p10.toxval.numeric.sub)]
invivo.all[, p15.toxval.numeric.sub := log10(p15.toxval.numeric.sub)]
invivo.all[, p20.toxval.numeric.sub := log10(p20.toxval.numeric.sub)]
invivo.all[, p25.toxval.numeric.sub := log10(p25.toxval.numeric.sub)]
invivo.all[, p30.toxval.numeric.sub := log10(p30.toxval.numeric.sub)]
```

Make all log.repdose values that combine ECHA and ToxVal per logic
```{r, warning=FALSE}

# ToxVal
invivo.all[, log.repdose.any.5th := ifelse(is.na(log.ECHA_min_systemic_POD_mkd), p5.toxval.numeric, log.ECHA_min_systemic_POD_mkd)]
invivo.all[, log.repdose.any.10th := ifelse(is.na(log.ECHA_min_systemic_POD_mkd), p10.toxval.numeric, log.ECHA_min_systemic_POD_mkd)]
invivo.all[, log.repdose.any.15th := ifelse(is.na(log.ECHA_min_systemic_POD_mkd), p15.toxval.numeric, log.ECHA_min_systemic_POD_mkd)]
invivo.all[, log.repdose.any.20th := ifelse(is.na(log.ECHA_min_systemic_POD_mkd), p20.toxval.numeric, log.ECHA_min_systemic_POD_mkd)]
invivo.all[, log.repdose.any.25th := ifelse(is.na(log.ECHA_min_systemic_POD_mkd), p25.toxval.numeric, log.ECHA_min_systemic_POD_mkd)]
invivo.all[, log.repdose.any.30th := ifelse(is.na(log.ECHA_min_systemic_POD_mkd), p30.toxval.numeric, log.ECHA_min_systemic_POD_mkd)]

# ToxVal - subchronic only
invivo.all[, log.repdose.90d.5th := ifelse(is.na(log.ECHA_min_systemic_POD_mkd), p5.toxval.numeric.sub, log.ECHA_min_systemic_POD_mkd)]
invivo.all[, log.repdose.90d.10th := ifelse(is.na(log.ECHA_min_systemic_POD_mkd), p10.toxval.numeric.sub, log.ECHA_min_systemic_POD_mkd)]
invivo.all[, log.repdose.90d.15th := ifelse(is.na(log.ECHA_min_systemic_POD_mkd), p15.toxval.numeric.sub, log.ECHA_min_systemic_POD_mkd)]
invivo.all[, log.repdose.90d.20th := ifelse(is.na(log.ECHA_min_systemic_POD_mkd), p20.toxval.numeric.sub, log.ECHA_min_systemic_POD_mkd)]
invivo.all[, log.repdose.90d.25th := ifelse(is.na(log.ECHA_min_systemic_POD_mkd), p25.toxval.numeric.sub, log.ECHA_min_systemic_POD_mkd)]
invivo.all[, log.repdose.90d.30th := ifelse(is.na(log.ECHA_min_systemic_POD_mkd), p30.toxval.numeric.sub, log.ECHA_min_systemic_POD_mkd)]

nrow(invivo.all[!is.na(log.repdose.90d.5th)]) # 163 chemicals with 90d repeat dose POD
nrow(invivo.all[!is.na(log.repdose.any.25th)]) # 167 chemicals with any repeat dose POD
```
# Compare ECHA and ToxVal values {.tabset .tabset-fade .tabset-pills}

## Compare in vivo PODs

```{r, warning=FALSE}

# make list of linear model comparisons
## Toxval 5p and 25 p to SUB only
iv.mod1 <- lm(p5.toxval.numeric ~ p5.toxval.numeric.sub, 
            data= invivo.all)
iv.mod2 <- lm(p25.toxval.numeric ~ p25.toxval.numeric.sub, 
            data= invivo.all)
# ECHA min systemic to Toxval
iv.mod3 <- lm(log.ECHA_min_systemic_POD_mkd ~ p5.toxval.numeric, 
            data= invivo.all)
iv.mod4 <- lm(log.ECHA_min_systemic_POD_mkd ~ p25.toxval.numeric, 
            data= invivo.all)

iv.mod1.rmse <- round(sqrt(mean(iv.mod1$residuals^2)),3)
iv.mod1.r2 <- round(summary(iv.mod1)$r.squared,3)

iv.mod2.rmse <- round(sqrt(mean(iv.mod2$residuals^2)),3)
iv.mod2.r2 <- round(summary(iv.mod2)$r.squared,3)

iv.mod3.rmse <- round(sqrt(mean(iv.mod3$residuals^2)),3)
iv.mod3.r2 <- round(summary(iv.mod3)$r.squared,3)

iv.mod4.rmse <- round(sqrt(mean(iv.mod4$residuals^2)),3)
iv.mod4.r2 <- round(summary(iv.mod4)$r.squared,3)

pod <- c('5th%ile SUB to 5th%ile',
         '25th%ile SUB to 25%ile',
         '5th%ile to Min ECHA',
         '25th%ile to Min ECHA')

pod.rmse <- c(iv.mod1.rmse,
              iv.mod2.rmse,
              iv.mod3.rmse,
              iv.mod4.rmse)

pod.r2 <- c(iv.mod1.r2,
            iv.mod2.r2,
            iv.mod3.r2,
            iv.mod4.r2)


summ.pod <- data.table(pod,
                   pod.rmse,
                   pod.r2)

setnames(summ.pod, c('pod','pod.rmse','pod.r2'), c('POD comparison','RMSE','R2'))
kable(summ.pod)

```

```{r, warning=FALSE}
# make in vivo data long to plot
invivo.all.long <- melt.data.table(invivo.all,
                                         id.vars=c('dsstox_substance_id',
                                                   'p5.toxval.numeric',
                                                   'p25.toxval.numeric'),
                                         measure.vars=c('p5.toxval.numeric.sub',
                                                     'p25.toxval.numeric.sub',
                                                     'log.ECHA_min_systemic_POD_mkd'),
                                         variable.name=c('comparator'),
                                         value.name = c('comparator.value'))

invivo.all.long <- melt.data.table(invivo.all.long,
                                         id.vars=c('dsstox_substance_id',
                                                   'comparator',
                                                   'comparator.value'),
                                         measure.vars=c('p5.toxval.numeric',
                                                        'p25.toxval.numeric'),
                                         variable.name=c('toxval'),
                                         value.name = c('toxval.value'))
```

```{r, warning=FALSE, fig.height=4, fig.width=9}

# new facet labels
comparator.labels <- c('5th %ile ToxVal SUB',
                  '25th %ile ToxVal SUB',
                  'Min ECHA Systemic')
names(comparator.labels) <- c('p5.toxval.numeric.sub',
                                                     'p25.toxval.numeric.sub',
                                                     'log.ECHA_min_systemic_POD_mkd')


pod.lm <- ggplot(data=invivo.all.long, 
                 aes(x=toxval.value, 
                     y=comparator.value, 
                     color=toxval, shape=toxval))+
  geom_point(aes(x=toxval.value, 
                     y=comparator.value, 
                     color=toxval, shape=toxval), alpha=0.7, size=2)+
  scale_color_manual(name='ToxVal %ile',
                     values=c('#481567FF','#95D840FF'),
                     labels=c('ToxVal 5th%ile', 'ToxVal 25th%ile'),
                     breaks = c('p5.toxval.numeric',
                                'p25.toxval.numeric'))+
  scale_shape_manual(name='ToxVal %ile',
                     values=c(15,17),
                     labels=c('ToxVal 5th%ile', 'ToxVal 25th%ile'),
                     breaks = c('p5.toxval.numeric',
                                'p25.toxval.numeric'))+
  scale_x_continuous(breaks=seq(-7, 5, 1))+
  scale_y_continuous(breaks=seq(-7, 5, 1))+
  coord_cartesian(xlim=c(-4,4), ylim=c(-4,4))+
  theme_bw()+
  geom_smooth(aes(group=toxval), method='lm',se=FALSE,formula=y~x)+
  stat_poly_eq(
               formula=y ~x,
               #eq.with.lhs = "y~`=`~",
               aes(label=paste0("atop(",..rr.label..,")")),
               parse=TRUE,
               #label.x=c(rep('right',3), 'left'),
               label.y=c(-2,-4),
               label.x=c(-3,1),
               size=5, face='bold')+
  geom_abline(slope=1, intercept=0) +
  geom_abline(slope=1, intercept=1, linetype="dashed") +
  geom_abline(slope=1, intercept=-1, linetype="dashed") +
  xlab('ToxVal POD, log10-mg/kg/day')+
  ylab('Comparator POD, log10-mg/kg/day')+
   theme(axis.text = element_text(size=12),
        axis.title = element_text(size=14))+
  facet_wrap(~comparator, scales='fixed', labeller = labeller(comparator=comparator.labels))+
  theme(strip.background = element_rect(fill='white',size=1),
        strip.text = element_text(size=10, color='black',face='bold'))

pod.lm
```


```{r, warning=FALSE}
mytheme <- gridExtra::ttheme_minimal(core=list(padding.v=unit(0.1, 'mm'), padding.h=unit(0.1,'mm')))
metric.grob <- grid.arrange(tableGrob(summ.pod, theme=mytheme))
```


```{r, warning=FALSE, fig.width=10, fig.height=8}

fig.PODcomp <- plot_grid(pod.lm,metric.grob,labels=c("A", "B"), rel_heights = c(1,0.5), rel_widths = c(1,0.5), label_size=18, nrow=2)
fig.PODcomp

```

```{r, eval=FALSE, echo=FALSE, warning=FALSE}

file.dir <- paste('output/', sep='')
file.name <- paste('/Fig_POD_invivo_comp_', Sys.Date(), '.tiff', sep='')
file.path <- paste(file.dir, file.name, sep='')
dir.create(path=file.dir, showWarnings = FALSE, recursive = TRUE)
tiff(file.path, width=9, height=7, units='in', res=450)
fig.PODcomp <- plot_grid(pod.lm,metric.grob,labels=c("A", "B"), rel_heights = c(1,0.5), rel_widths = c(1,0.5), label_size=18, nrow=2)
fig.PODcomp

dev.off()
 


```
Merge in vivo PODs with primary data table.
```{r, warning=FALSE}

asnm.tier1.all.invivo <- merge.data.table(asnm.tier1.all, 
                                          invivo.all[,c('dsstox_substance_id',
                                                        "data_poor_binary",
                                                        "ECHA_min_systemic_POD_mkd",
                                                        "log.ECHA_min_systemic_POD_mkd",
                                                        "log.repdose.90d.5th",
                                                        "log.repdose.90d.10th",
                                                        "log.repdose.90d.15th",
                                                        "log.repdose.90d.20th",
                                                        "log.repdose.90d.25th",
                                                        "log.repdose.90d.30th",
                                                        "log.repdose.any.5th",
                                                        "log.repdose.any.10th",
                                                        "log.repdose.any.15th",
                                                        "log.repdose.any.20th",
                                                        "log.repdose.any.25th",
                                                        "log.repdose.any.30th")],
                                          all.x = TRUE,
                                          by='dsstox_substance_id')
```

# Comparison to TTC {.tabset .tabset-fade .tabset-pills}

## in silico TTC

```{r, warning=FALSE}
# import TTC predictions
ttc <- as.data.table(read.xlsx('./source/chem/apcra_pro_TTC.xlsx', colNames = TRUE))
colnames(ttc)
setnames(ttc, colnames(ttc), c('dtxsid','casrn','preferred_name','CAN_SMILES','Cramer','ug.kg.bw.day'))
ttc$ug.kg.bw.day <- as.numeric(ttc$ug.kg.bw.day)
```

```{r, warning=FALSE}

asnm.tier1.all.invivo <- merge.data.table(asnm.tier1.all.invivo,
                                       ttc[,c('dtxsid','ug.kg.bw.day')],
                                       by.y=c('dtxsid'),
                                       by.x=c('dsstox_substance_id'),
                                       all.x=TRUE)

asnm.tier1.all.invivo[,ttc := log10(ug.kg.bw.day/1000)]
asnm.tier1.all.invivo$chnm <- apcra.list$preferred_name[match(asnm.tier1.all.invivo$dsstox_substance_id,
                                                              apcra.list$DTXSID)]
```

```{r, warning=FALSE}

asnm.tier1.all.invivo[,pod.ratio := log.repdose.any.5th - med.aed50, by=dsstox_substance_id]
asnm.tier1.all.invivo[,ttc.ratio := log.repdose.any.5th - ttc, by=dsstox_substance_id]
asnm.tier1.all.invivo[,sub.ratio := log.repdose.any.5th - log.repdose.90d.5th, by=dsstox_substance_id]

```

```{r, warning=FALSE, eval=FALSE}

write.xlsx(asnm.tier1.all.invivo, file='./output/asnm_tier1_all_invivo.xlsx')


```

```{r, warning=FALSE}
kable(asnm.tier1.all.invivo[, c('log.repdose.any.5th',
                                    'med.aed50',
                                    'ttc',
                                    'log.repdose.90d.5th', 
                                    'pod.ratio',
                                    'ttc.ratio',
                                    'sub.ratio')],
           filter='top', 
          options=list(pagelength=25, autoWidth=FALSE,  scrollX=TRUE, initComplete = JS(
    "function(settings, json) {",
    "$('body').css({'font-family': 'Calibri'});",
    "}"
  )))
```

```{r, warning=FALSE}
asnm.tier1.all.invivo.long <- melt.data.table(asnm.tier1.all.invivo,
                                         id.vars = c('dsstox_substance_id', 'chnm','log.repdose.any.5th',
                                    'med.aed50',
                                    'ttc',
                                    'log.repdose.90d.5th'),
                                         measure.vars = c( 
                                    'pod.ratio',
                                    'ttc.ratio',
                                    'sub.ratio'),
                 variable.name = c('ratio.type'),
                 value.name = c('ratio'))
```

```{r, warning=FALSE}

pod.ratios <- ggplot(data=asnm.tier1.all.invivo.long, aes(x=ratio,fill=ratio.type))+
  geom_histogram(position='identity',binwidth = 0.33, alpha=0.7)+
  scale_x_continuous(breaks=seq(-5,10,1))+
  scale_fill_viridis(name='Ratio Type', discrete=TRUE, labels=c('POD ratio','TTC ratio','SUB ratio'))+
  #scale_color_viridis(discrete=TRUE)+
  theme_bw()+
  theme(axis.text = element_text(size=12),
        axis.title = element_text(size=14))+
  xlab("POD ratios, log10-mg/kg/day")+
  ylab("count")+
  #coord_cartesian(xlim=c(0,6))+
  geom_vline(xintercept=median(asnm.tier1.all.invivo$pod.ratio, na.rm=TRUE), col='red', linetype='dashed')+
  geom_vline(xintercept=median(asnm.tier1.all.invivo$ttc.ratio, na.rm=TRUE), col='blue', linetype='dashed')

pod.ratios
```

```{r, warning=FALSE}
asnm.tier1.all.invivo[pod.ratio > 3, pod.ratio.size := as.character('med.aed50 too small')]
asnm.tier1.all.invivo[pod.ratio < -3, pod.ratio.size := as.character('med.aed50 too big')]

large.delta.pod.ratio <- asnm.tier1.all.invivo[pod.ratio.size %in% c('med.aed50 too small','med.aed50 too big'), c('chnm','dsstox_substance_id',
                                                                                                                   'log.repdose.any.5th',
                                    'med.aed50',
                                    'pod.ratio')]


setnames(large.delta.pod.ratio, c(1:5), c('chnm','DTXSID','5th%ile POD-trad','Med AED50','POD ratio'))
large.delta.pod.ratio[, `5th%ile POD-trad` := round(`5th%ile POD-trad`, 2)]
large.delta.pod.ratio[, `Med AED50` := round(`Med AED50`, 2)]
large.delta.pod.ratio[, `POD ratio` := round(`POD ratio`, 2)]
large.delta.pod.ratio <- large.delta.pod.ratio[order(`POD ratio`)]

cols <- matrix(c("#000000"),nrow(large.delta.pod.ratio), ncol(large.delta.pod.ratio))
tt <- ttheme_minimal(
  core=list(fg_params = list(col = cols, cex=1.0),
            bg_params = list(col=NA)),
  rowhead=list(bg_params = list(col=NA), fg_params = list(fontface = "bold",
                                                          cex=1.0)),
  colhead=list(bg_params = list(col=NA), fg_params = list(cex=1.0)))
t.podratio <- tableGrob(large.delta.pod.ratio, theme = tt)

```

```{r, warning=FALSE, fig.width=9, fig.height=10}
plot_grid(pod.ratios, t.podratio, labels = c('A', 'B'), label_size = 18, nrow =2, rel_heights = c(1, 0.5))
```

```{r, warning=FALSE, eval=FALSE}

file.dir <- paste('output/', sep='')
file.name <- paste('/Fig6_PODratios_comp_', Sys.Date(), '.tiff', sep='')
file.path <- paste(file.dir, file.name, sep='')
dir.create(path=file.dir, showWarnings = FALSE, recursive = TRUE)
tiff(file.path, width=8, height=9, units='in', res=450)
plot_grid(pod.ratios, t.podratio, labels = c('A', 'B'), label_size = 18, nrow =2, rel_heights = c(1, 0.5))
dev.off()
```

# ECDF Plots of POD ratios {.tabset .tabset-fade .tabset-pills}

The purpose of this section is to calculate ratios by assay technology or by technology type (targeted, broad, hipptox).
Then we want to examine the use of these data in the POD ratio calculation via an empirical cumulative distribution plot(s).
32 chemicals do not have any repeat dose POD (164 have it).

```{r load-ratio-data, warning=FALSE}

#asnm.tier1.all.invivo <- as.data.table(read.xlsx('./output/asnm_tier1_all_invivo.xlsx', colNames = TRUE,na.strings='NA'))
colnames(asnm.tier1.all.invivo)
#asnm.tier1.all.ratios <- asnm.tier1.all.invivo[,c(1,29:46, 59:61, 64, 67:68)] # need to reduce the col number of the data.table
asnm.tier1.all.invivo[is.na(log.repdose.any.5th)] # 32 rows
```

All median and minimum battery POD ratios
```{r,warning=FALSE}
asnm.tier1.all.invivo[,pod.ratio10 := log.repdose.any.10th - med.aed50, by=dsstox_substance_id]
asnm.tier1.all.invivo[,pod.ratio15 := log.repdose.any.15th - med.aed50, by=dsstox_substance_id]
asnm.tier1.all.invivo[,pod.ratio20 := log.repdose.any.20th - med.aed50, by=dsstox_substance_id]
asnm.tier1.all.invivo[,pod.ratio25 := log.repdose.any.25th - med.aed50, by=dsstox_substance_id]
asnm.tier1.all.invivo[,pod.ratio30 := log.repdose.any.30th - med.aed50, by=dsstox_substance_id]

asnm.tier1.all.invivo[,pod.min.ratio5 := log.repdose.any.5th - min.aed50, by=dsstox_substance_id]
asnm.tier1.all.invivo[,pod.min.ratio10 := log.repdose.any.10th - min.aed50, by=dsstox_substance_id]
asnm.tier1.all.invivo[,pod.min.ratio15 := log.repdose.any.15th - min.aed50, by=dsstox_substance_id]
asnm.tier1.all.invivo[,pod.min.ratio20 := log.repdose.any.20th - min.aed50, by=dsstox_substance_id]
asnm.tier1.all.invivo[,pod.min.ratio25 := log.repdose.any.25th - min.aed50, by=dsstox_substance_id]
asnm.tier1.all.invivo[,pod.min.ratio30 := log.repdose.any.30th - min.aed50, by=dsstox_substance_id]

asnm.tier1.all.ratios <- as.data.table(asnm.tier1.all.invivo)

```

Calculate ratios by specific assay technology, in the form log10(podtraditional - podnam). All of these values are already in log10 units.

Targeted technologies to all ToxVal %iles

```{r calc-targeted-assay-ratios, warning=FALSE}

## targeted technologies to 5th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.atg=log.repdose.any.5th - aed50.atg,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.biomap=log.repdose.any.5th - aed50.bsk,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.mea=log.repdose.any.5th - aed50.ccte,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.nvs=log.repdose.any.5th - aed50.nvs,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.stm=log.repdose.any.5th - aed50.stm,na.rm=TRUE) %>% data.table()

## targeted technologies to 10th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.atg=log.repdose.any.10th - aed50.atg,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.biomap=log.repdose.any.10th - aed50.bsk,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.mea=log.repdose.any.10th - aed50.ccte,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.nvs=log.repdose.any.10th - aed50.nvs,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.stm=log.repdose.any.10th - aed50.stm,na.rm=TRUE) %>% data.table()

## targeted technologies to 15th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.atg=log.repdose.any.15th - aed50.atg,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.biomap=log.repdose.any.15th - aed50.bsk,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.mea=log.repdose.any.15th - aed50.ccte,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.nvs=log.repdose.any.15th - aed50.nvs,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.stm=log.repdose.any.15th - aed50.stm,na.rm=TRUE) %>% data.table()

## targeted technologies to 20th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.atg=log.repdose.any.20th - aed50.atg,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.biomap=log.repdose.any.20th - aed50.bsk,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.mea=log.repdose.any.20th - aed50.ccte,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.nvs=log.repdose.any.20th - aed50.nvs,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.stm=log.repdose.any.20th - aed50.stm,na.rm=TRUE) %>% data.table()

## targeted technologies to 25th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.atg=log.repdose.any.25th - aed50.atg,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.biomap=log.repdose.any.25th - aed50.bsk,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.mea=log.repdose.any.25th - aed50.ccte,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.nvs=log.repdose.any.25th - aed50.nvs,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.stm=log.repdose.any.25th - aed50.stm,na.rm=TRUE) %>% data.table()

## targeted technologies to 30th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.atg=log.repdose.any.30th - aed50.atg,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.biomap=log.repdose.any.30th - aed50.bsk,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.mea=log.repdose.any.30th - aed50.ccte,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.nvs=log.repdose.any.30th - aed50.nvs,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.stm=log.repdose.any.30th - aed50.stm,na.rm=TRUE) %>% data.table()
```

Broad technologies to all ToxVal %iles
```{r, warning=FALSE}
## broad technologies to 5th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.httr.mcf7=log.repdose.any.5th - aed50.httr.mcf7,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.httr.u2os=log.repdose.any.5th - aed50.httr.u2os,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.httr.heparg=log.repdose.any.5th - aed50.httr.heparg,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.htpp.u2os=log.repdose.any.5th - aed50.htpp.u2os,na.rm=TRUE) %>% data.table()

## broad technologies to 10th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.httr.mcf7=log.repdose.any.10th - aed50.httr.mcf7,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.httr.u2os=log.repdose.any.10th - aed50.httr.u2os,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.httr.heparg=log.repdose.any.10th - aed50.httr.heparg,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.htpp.u2os=log.repdose.any.10th - aed50.htpp.u2os,na.rm=TRUE) %>% data.table()

## broad technologies to 15th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.httr.mcf7=log.repdose.any.15th - aed50.httr.mcf7,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.httr.u2os=log.repdose.any.15th - aed50.httr.u2os,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.httr.heparg=log.repdose.any.15th - aed50.httr.heparg,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.htpp.u2os=log.repdose.any.15th - aed50.htpp.u2os,na.rm=TRUE) %>% data.table()

## broad technologies to 20th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.httr.mcf7=log.repdose.any.20th - aed50.httr.mcf7,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.httr.u2os=log.repdose.any.20th - aed50.httr.u2os,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.httr.heparg=log.repdose.any.20th - aed50.httr.heparg,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.htpp.u2os=log.repdose.any.20th - aed50.htpp.u2os,na.rm=TRUE) %>% data.table()

## broad technologies to 25th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.httr.mcf7=log.repdose.any.25th - aed50.httr.mcf7,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.httr.u2os=log.repdose.any.25th - aed50.httr.u2os,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.httr.heparg=log.repdose.any.25th - aed50.httr.heparg,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.htpp.u2os=log.repdose.any.25th - aed50.htpp.u2os,na.rm=TRUE) %>% data.table()

## broad technologies to 30th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.httr.mcf7=log.repdose.any.30th - aed50.httr.mcf7,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.httr.u2os=log.repdose.any.30th - aed50.httr.u2os,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.httr.heparg=log.repdose.any.30th - aed50.httr.heparg,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.htpp.u2os=log.repdose.any.30th - aed50.htpp.u2os,na.rm=TRUE) %>% data.table()
```

ASTAR assays to all ToxVal %iles
```{r, warning=FALSE}
## astar hipptox to 5th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.hipptox.beas2b=log.repdose.any.5th - aed50.astar.beas2b,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.hipptox.hepg2=log.repdose.any.5th - aed50.astar.hepg2,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.hipptox.hk2=log.repdose.any.5th - aed50.astar.hek293,na.rm=TRUE) %>% data.table()

## astar hipptox to 10th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.hipptox.beas2b=log.repdose.any.10th - aed50.astar.beas2b,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.hipptox.hepg2=log.repdose.any.10th - aed50.astar.hepg2,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.hipptox.hk2=log.repdose.any.10th - aed50.astar.hek293,na.rm=TRUE) %>% data.table()

## astar hipptox to 5th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.hipptox.beas2b=log.repdose.any.15th - aed50.astar.beas2b,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.hipptox.hepg2=log.repdose.any.15th - aed50.astar.hepg2,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.hipptox.hk2=log.repdose.any.15th - aed50.astar.hek293,na.rm=TRUE) %>% data.table()

## astar hipptox to 5th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.hipptox.beas2b=log.repdose.any.20th - aed50.astar.beas2b,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.hipptox.hepg2=log.repdose.any.20th - aed50.astar.hepg2,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.hipptox.hk2=log.repdose.any.20th - aed50.astar.hek293,na.rm=TRUE) %>% data.table()

## astar hipptox to 25th %ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.hipptox.beas2b=log.repdose.any.25th - aed50.astar.beas2b,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.hipptox.hepg2=log.repdose.any.25th - aed50.astar.hepg2,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.hipptox.hk2=log.repdose.any.25th - aed50.astar.hek293,na.rm=TRUE) %>% data.table()

## astar hipptox to 30th%ile POD

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.hipptox.beas2b=log.repdose.any.30th - aed50.astar.beas2b,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.hipptox.hepg2=log.repdose.any.30th - aed50.astar.hepg2,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.hipptox.hk2=log.repdose.any.30th - aed50.astar.hek293,na.rm=TRUE) %>% data.table()

```
MLR ratios
```{r, warning=FALSE}

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.mlr5=log.repdose.any.5th - mlr.toxval5.aed50,na.rm=TRUE) %>% data.table()
asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.mlr25=log.repdose.any.25th - mlr.toxval25.aed50,na.rm=TRUE) %>% data.table()
```

```{r, warning=FALSE}
setnames(asnm.tier1.all.ratios, c('pod.ratio'), c('pod.ratio5'))
```

Add calculation of %ile ratios by median assay type (broad, targeted, hipptox, broad+targeted).

Minimum targeted AED values for POD ratios.
```{r min-aed-pod-ratios, warning=FALSE}

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.min.target=min(c(ratio5.atg,
                                                                                                  ratio5.biomap,
                                                                                                  #ratio5.mea,
                                                                                                  ratio5.nvs,
                                                                                                  ratio5.stm), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.min.target=min(c(ratio10.atg,
                                                                                                  ratio10.biomap,
                                                                                                  #ratio5.mea,
                                                                                                  ratio10.nvs,
                                                                                                  ratio10.stm), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.min.target=min(c(ratio15.atg,
                                                                                                  ratio15.biomap,
                                                                                                  #ratio5.mea,
                                                                                                  ratio15.nvs,
                                                                                                  ratio15.stm), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.min.target=min(c(ratio20.atg,
                                                                                                  ratio20.biomap,
                                                                                                  #ratio5.mea,
                                                                                                  ratio20.nvs,
                                                                                                  ratio20.stm), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.min.target=min(c(ratio25.atg,
                                                                                                  ratio25.biomap,
                                                                                                  #ratio5.mea,
                                                                                                  ratio25.nvs,
                                                                                                  ratio25.stm), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.min.target=min(c(ratio30.atg,
                                                                                                  ratio30.biomap,
                                                                                                  #ratio5.mea,
                                                                                                  ratio30.nvs,
                                                                                                  ratio30.stm), na.rm=TRUE)) %>% data.table()
```

Median targeted AED values for POD ratios
```{r med-aed-pod-ratios, warning=FALSE}

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.med.target=median(c(ratio5.atg,
                                                                                                  ratio5.biomap,
                                                                                                  #ratio5.mea,
                                                                                                  ratio5.nvs,
                                                                                                  ratio5.stm), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.med.target=median(c(ratio10.atg,
                                                                                                  ratio10.biomap,
                                                                                                  #ratio5.mea,
                                                                                                  ratio10.nvs,
                                                                                                  ratio10.stm), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.med.target=median(c(ratio15.atg,
                                                                                                  ratio15.biomap,
                                                                                                  #ratio5.mea,
                                                                                                  ratio15.nvs,
                                                                                                  ratio15.stm), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.med.target=median(c(ratio20.atg,
                                                                                                  ratio20.biomap,
                                                                                                  #ratio5.mea,
                                                                                                  ratio20.nvs,
                                                                                                  ratio20.stm), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.med.target=median(c(ratio25.atg,
                                                                                                  ratio25.biomap,
                                                                                                  #ratio5.mea,
                                                                                                  ratio25.nvs,
                                                                                                  ratio25.stm), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.med.target=median(c(ratio30.atg,
                                                                                                  ratio30.biomap,
                                                                                                  #ratio5.mea,
                                                                                                  ratio30.nvs,
                                                                                                  ratio30.stm), na.rm=TRUE)) %>% data.table()
```

Min broad AED values for POD ratios

```{r min-broad-pod-ratios, warning=FALSE}

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.min.broad=min(c(ratio5.httr.mcf7,
                                                                                                  ratio5.httr.u2os,
                                                                                                  ratio5.httr.heparg,
                                                                                                  ratio5.htpp.u2os), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.min.broad=min(c(ratio10.httr.mcf7,
                                                                                                  ratio10.httr.u2os,
                                                                                                  ratio10.httr.heparg,
                                                                                                  ratio10.htpp.u2os), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.min.broad=min(c(ratio15.httr.mcf7,
                                                                                                  ratio15.httr.u2os,
                                                                                                  ratio15.httr.heparg,
                                                                                                  ratio15.htpp.u2os), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.min.broad=min(c(ratio20.httr.mcf7,
                                                                                                  ratio20.httr.u2os,
                                                                                                  ratio20.httr.heparg,
                                                                                                  ratio20.htpp.u2os), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.min.broad=min(c(ratio25.httr.mcf7,
                                                                                                  ratio25.httr.u2os,
                                                                                                  ratio25.httr.heparg,
                                                                                                  ratio25.htpp.u2os), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.min.broad=min(c(ratio30.httr.mcf7,
                                                                                                  ratio30.httr.u2os,
                                                                                                  ratio30.httr.heparg,
                                                                                                  ratio30.htpp.u2os), na.rm=TRUE)) %>% data.table()

```

Median broad AED values for POD ratios
```{r med-broad-pod-ratios, warning=FALSE}

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.med.broad=median(c(ratio5.httr.mcf7,
                                                                                                  ratio5.httr.u2os,
                                                                                                  ratio5.httr.heparg,
                                                                                                  ratio5.htpp.u2os), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio10.med.broad=median(c(ratio10.httr.mcf7,
                                                                                                  ratio10.httr.u2os,
                                                                                                  ratio10.httr.heparg,
                                                                                                  ratio10.htpp.u2os), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio15.med.broad=median(c(ratio15.httr.mcf7,
                                                                                                  ratio15.httr.u2os,
                                                                                                  ratio15.httr.heparg,
                                                                                                  ratio15.htpp.u2os), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio20.med.broad=median(c(ratio20.httr.mcf7,
                                                                                                  ratio20.httr.u2os,
                                                                                                  ratio20.httr.heparg,
                                                                                                  ratio20.htpp.u2os), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.med.broad=median(c(ratio25.httr.mcf7,
                                                                                                  ratio25.httr.u2os,
                                                                                                  ratio25.httr.heparg,
                                                                                                  ratio25.htpp.u2os), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio30.med.broad=median(c(ratio30.httr.mcf7,
                                                                                                  ratio30.httr.u2os,
                                                                                                  ratio30.httr.heparg,
                                                                                                  ratio30.htpp.u2os), na.rm=TRUE)) %>% data.table()
```

Other pod ratios needed for summary plots
```{r calc-other-pod-ratios, warning=FALSE}

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.med.coretarget=median(c(ratio5.atg,
                                                                                                  ratio5.biomap,
                                                                                                  ratio5.nvs), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.med.hipptox=median(c(ratio5.hipptox.beas2b, ratio5.hipptox.hepg2,ratio5.hipptox.hk2),na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio5.med.brta=median(c(ratio5.atg,
                                                                                                  ratio5.biomap,
                                                                                                  ratio5.nvs,
                                                                                                  ratio5.httr.mcf7,
                                                                                                  ratio5.httr.u2os,
                                                                                                  ratio5.httr.heparg,
                                                                                                  ratio5.htpp.u2os), na.rm=TRUE)) %>% data.table()
```

```{r calc-pod-ratios25-type, warning=FALSE}

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.med.coretarget=median(c(ratio25.atg,
                                                                                                  ratio25.biomap,
                                                                                                  ratio25.nvs), na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.med.hipptox = median(c(ratio25.hipptox.beas2b, ratio25.hipptox.hepg2,ratio25.hipptox.hk2),na.rm=TRUE)) %>% data.table()

asnm.tier1.all.ratios <- asnm.tier1.all.ratios %>% rowwise() %>% mutate(ratio25.med.brta=median(c(ratio25.atg,
                                                                                                  ratio25.biomap,
                                                                                                  ratio25.nvs,
                                                                                                  ratio25.httr.mcf7,
                                                                                                  ratio25.httr.u2os,
                                                                                                  ratio25.httr.heparg,
                                                                                                  ratio25.htpp.u2os),na.rm=TRUE)) %>% data.table()
```

Need to melt the ratios into long format by ratio type.

```{r melt-ratios-long, warning=FALSE}

asnm.tier1.all.ratios.long <- melt.data.table(asnm.tier1.all.ratios,
                                              id.vars = c('dsstox_substance_id',
                                                          'CASRN',
                                                          'preferred_name',
                                                          'apcra.pro.only',
                                                          'med.aed50',
                                                          'min.aed50',
                                                          'log.repdose.any.5th',
                                                          'log.repdose.any.25th'
                                                          ),
                                              measure.vars = c('pod.ratio5',
                                                  'ratio5.atg',
                                                  'ratio5.biomap',
                                                  'ratio5.mea',
                                                  'ratio5.nvs',
                                                  'ratio5.stm',
                                                  'ratio5.httr.mcf7',
                                                  'ratio5.httr.u2os',
                                                  'ratio5.httr.heparg',
                                                  'ratio5.htpp.u2os',
                                                  'ratio5.hipptox.beas2b',
                                                  'ratio5.hipptox.hepg2',
                                                  'ratio5.hipptox.hk2',
                                                  'ratio5.med.target',
                                                  'ratio5.med.coretarget',
                                                  'ratio5.med.broad',
                                                  'ratio5.med.hipptox',
                                                  'ratio5.med.brta',
                                                  'pod.ratio25',
                                                          'ratio25.atg',
                                                  'ratio25.biomap',
                                                  'ratio25.mea',
                                                  'ratio25.nvs',
                                                  'ratio25.stm',
                                                  'ratio25.httr.mcf7',
                                                  'ratio25.httr.u2os',
                                                  'ratio25.httr.heparg',
                                                  'ratio25.htpp.u2os',
                                                  'ratio25.hipptox.beas2b',
                                                  'ratio25.hipptox.hepg2',
                                                  'ratio25.hipptox.hk2',
                                                  'ratio25.med.target',
                                                  'ratio25.med.coretarget',
                                                  'ratio25.med.broad',
                                                  'ratio25.med.hipptox',
                                                  'ratio25.med.brta'
                                                  
                                                  ),
                                              variable.name = c('Ratio'),
                                              value.name = c('Ratio.value'))
```

Work on ECDF plot.
```{r, warning=FALSE, fig.width=10, fig.height=6}
fig.ratio.ecdfa <- ggplot(asnm.tier1.all.ratios.long[Ratio %in% c('pod.ratio5',
                                                  'ratio5.med.target',
                                                  'ratio5.med.broad',
                                                  'ratio5.med.hipptox',
                                                  'ratio5.med.coretarget',
                                                  'ratio5.med.brta')], aes(Ratio.value, color=Ratio))+
  stat_ecdf(geom='step', size=1.5)+
  #scale_y_continuous(trans = 'log10',
  #                   breaks= c(0.01, 0.1,0.2,0.3,0.4,0.5,0.75,1))+
  ylab("Cumulative Frequency") +
  xlab('log10 POD Ratio, 5th%ile POD')+
  theme_bw() +
  theme(
    axis.line = element_line(colour = "black"),
    axis.text = element_text(size=10),
    axis.title = element_text(size=12, face='bold'))+
  theme(axis.text.y = element_text(family = "sans", face = "bold", size=12))+
  theme(legend.position="right", legend.title=element_blank())+
  scale_x_continuous(breaks=seq(-5,10,1)) +
  coord_cartesian(xlim = c(-5, 10)) +
  #scale_color_viridis(discrete=TRUE, name='Ratio Type')+
  scale_colour_manual(breaks=c('pod.ratio5',
                                                  'ratio5.med.target',
                                                  'ratio5.med.broad',
                                                  'ratio5.med.hipptox',
                                                  'ratio5.med.coretarget',
                                                  'ratio5.med.brta'
                               ),
                      values=c("red", "#440154FF", "#3B528BFF", "#21908CFF", "#5DC863FF", "#FDE725FF"),
                      labels=c("MED POD Ratio", "POD-Med Targeted", "POD-Med Broad", "POD-Med HIPPTox", 'POD-Core Targeted','POD-Med Broad + Core Targeted'))+
  geom_vline(xintercept=-2, lty='dashed', color='red')+
  geom_vline(xintercept=2, lty='dashed', color='red')+
  geom_vline(xintercept=0, color='red')+
  geom_hline(yintercept=0.90, lty='dashed', color='red')

fig.ratio.ecdfa

```

```{r, warning=FALSE, fig.width=10, fig.height=6}
fig.ratio.ecdfb <- ggplot(asnm.tier1.all.ratios.long[Ratio %in% c('pod.ratio25',
                                                  'ratio25.med.target',
                                                  'ratio25.med.broad',
                                                  'ratio25.med.hipptox',
                                                  'ratio25.med.coretarget',
                                                  'ratio25.med.brta')], aes(Ratio.value, color=Ratio))+
  stat_ecdf(geom='step', size=1.5)+
  #scale_y_continuous(trans = 'log10',
  #                   breaks= c(0.01, 0.1,0.2,0.3,0.4,0.5,0.75,1))+
  ylab("Cumulative Frequency") +
  xlab('log10 POD Ratio, 25th %ile POD')+
  theme_bw() +
  theme(
    axis.line = element_line(colour = "black"),
    axis.text = element_text(size=10),
    axis.title = element_text(size=12, face='bold'))+
  theme(axis.text.y = element_text(family = "sans", face = "bold", size=12))+
  theme(legend.position="right", legend.title=element_blank())+
  scale_x_continuous(breaks=seq(-5,10,1)) +
  coord_cartesian(xlim = c(-5, 10)) +
  #scale_color_viridis(discrete=TRUE, name='Ratio Type')+
  scale_colour_manual(breaks=c('pod.ratio25',
                                                  'ratio25.med.target',
                                                  'ratio25.med.broad',
                                                  'ratio25.med.hipptox',
                                                  'ratio25.med.coretarget',
                                                  'ratio25.med.brta'
                               ),
                      values=c("red", "#440154FF", "#3B528BFF", "#21908CFF", "#5DC863FF", "#FDE725FF"),
                      labels=c("MED POD Ratio", "POD-Med Targeted", "POD-Med Broad", "POD-Med HIPPTox", 'POD-Core Targeted','POD-Med Broad + Core Targeted'))+
  geom_vline(xintercept=-2, lty='dashed', color='red')+
  geom_vline(xintercept=2, lty='dashed', color='red')+
  geom_vline(xintercept=0, color='red')+
  geom_hline(yintercept=0.90, lty='dashed', color='red')

fig.ratio.ecdfb

```
```{r, warning=FALSE, fig.width=9, fig.height=10}
plot_grid(fig.ratio.ecdfa,
          fig.ratio.ecdfb,
          labels = c('A', 'B'), label_size = 18, nrow =2)
```

```{r, warning=FALSE, eval=FALSE}

file.dir <- paste('output/', sep='')
file.name <- paste('/Fig_PODecdfs_comp_', Sys.Date(), '.tiff', sep='')
file.path <- paste(file.dir, file.name, sep='')
dir.create(path=file.dir, showWarnings = FALSE, recursive = TRUE)
tiff(file.path, width=8, height=8, units='in', res=300)

plot_grid(fig.ratio.ecdfa,
          fig.ratio.ecdfb,
          labels = c('A', 'B'), label_size = 18, ncol =1)
dev.off()


```
## Make boxplots of the POD ratio distributions

```{r, warning=FALSE}

asnm.tier1.all.ratios.long[grep('ratio5',Ratio), Ratio.type := 'POD5p']
asnm.tier1.all.ratios.long[grep('ratio25',Ratio), Ratio.type := 'POD25p']

```

```{r, warning=FALSE}
subset.long <- asnm.tier1.all.ratios.long[Ratio %in% c('ratio5.med.hipptox',
                                                       'ratio25.med.hipptox',
                                                   'pod.ratio5',
                                                   'pod.ratio25',
                                                   'ratio5.med.broad',
                                                   'ratio25.med.broad',
                                                   'ratio5.med.brta',
                                                   'ratio25.med.brta',
                                                  'ratio5.med.target',
                                                  'ratio25.med.target',
                                                  'ratio5.med.coretarget',
                                                  'ratio25.med.coretarget'
                                                  )]
subset.long$Ratio <- factor(subset.long$Ratio, levels=c('ratio5.med.hipptox',
                                                       'ratio25.med.hipptox',
                                                   'pod.ratio5',
                                                   'pod.ratio25',
                                                   'ratio5.med.broad',
                                                   'ratio25.med.broad',
                                                   'ratio5.med.brta',
                                                   'ratio25.med.brta',
                                                  'ratio5.med.target',
                                                  'ratio25.med.target',
                                                  'ratio5.med.coretarget',
                                                  'ratio25.med.coretarget'
                                                  ), ordered=TRUE)
```

```{r, warning=FALSE, fig.width=9, fig.height=9}
  
fig.box.pod.ratio <- ggplot(data=subset.long[Ratio %in% c('ratio5.med.hipptox',
                                                       'ratio25.med.hipptox',
                                                   'pod.ratio5',
                                                   'pod.ratio25',
                                                   'ratio5.med.broad',
                                                   'ratio25.med.broad',
                                                   'ratio5.med.brta',
                                                   'ratio25.med.brta',
                                                  'ratio5.med.target',
                                                  'ratio25.med.target',
                                                  'ratio5.med.coretarget',
                                                  'ratio25.med.coretarget'
                                                  )],
           aes(y=Ratio.value, x=factor(Ratio), fill=Ratio.type))+
      geom_boxplot(alpha=0.5,width = 0.33)+
      geom_jitter(alpha=0.3, color='black')+
      scale_y_continuous(breaks=seq(-6, 6, 1))+
  scale_fill_manual(name='POD Type',
                    values=c('#481567FF','#95D840FF'),
                     labels=c('ToxVal 5th%ile', 'ToxVal 25th%ile'),
                     breaks = c('POD5p','POD25p'))+
  scale_x_discrete(labels=c('POD-Med HIPPTox', 'POD-Med HIPPTox',
                            "MED POD Ratio", "MED POD Ratio",
                            "POD-Med Broad", "POD-Med Broad",
                            'POD-Med Broad + Core Targeted', 'POD-Med Broad + Core Targeted',
                            "POD-Med Targeted", "POD-Med Targeted",
                            'POD-Core Targeted', 'POD-Core Targeted'))+
      xlab('POD Ratio Type') +
      ylab('log10 POD Ratio Value')+
      theme_bw() +
      theme(
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size=10),
        axis.title = element_text(size=12, face='bold'))+
      theme(axis.text.x = element_text(family = "sans", size=10, angle=90, hjust=1))+
      theme(legend.position="right")+
  geom_hline(yintercept = 0, lty='dashed', color='red', size=2)

fig.box.pod.ratio
  
```
```{r, warning=FALSE, eval=FALSE}

file.dir <- paste('output/', sep='')
file.name <- paste('/Fig_PODratiobox_comp_', Sys.Date(), '.tiff', sep='')
file.path <- paste(file.dir, file.name, sep='')
dir.create(path=file.dir, showWarnings = FALSE, recursive = TRUE)
tiff(file.path, width=8, height=6, units='in', res=300)
fig.box.pod.ratio
dev.off()


```
# Update Table 2 with Ratio Counts

```{r, warning=FALSE}
# get Inf to NA in table
for (j in 1:ncol(asnm.tier1.all.ratios)) set(asnm.tier1.all.ratios, which(is.infinite(asnm.tier1.all.ratios[[j]])), j, NA)

## reduce table to the Table 2 outputs
#dput(colnames(asnm.tier1.all.ratios))
non_NA_counts <- as.data.frame(sapply(asnm.tier1.all.ratios, function(x) sum(!is.na(x))))
asnm.ratio.counts <- as.data.table(asnm.tier1.all.ratios[,c("min.aed50", # AED50 values
                                                            "med.aed50", 
                                                            "min.broad.aed50",
                                                            "min.targeted.aed50", 
                                                            "med.broad.aed50",
                                                            "med.targeted.aed50", 
                                                            "aed50.atg", 
                                                            "aed50.bsk", 
                                                            "aed50.nvs", 
                                                            "aed50.stm", 
                                                            "aed50.htpp.u2os",
                                                            "aed50.httr.heparg",
                                                            "aed50.httr.mcf7", 
                                                            "aed50.httr.u2os",
                                                            "aed50.astar.beas2b",
                                                            "aed50.astar.hepg2",
                                                            "aed50.astar.hek293",
                                                            "mlr.toxval5.aed50", 
                                                            "mlr.toxval25.aed50",
                                                            
                                                            "log.repdose.any.5th", #ToxVal+ECHA in vivo values
                                                            "log.repdose.any.10th",
                                                            "log.repdose.any.15th",
                                                            "log.repdose.any.20th",
                                                            "log.repdose.any.25th",
                                                            "log.repdose.any.30th", 
                                                            
                                                            "pod.min.ratio5", # Battery Min POD ratios
                                                            "pod.min.ratio10",
                                                            "pod.min.ratio15",
                                                            "pod.min.ratio20",
                                                            "pod.min.ratio25",
                                                            "pod.min.ratio30",
                                                            
                                                            "pod.ratio5", # Battery Med POD ratios
                                                            "pod.ratio10",
                                                            "pod.ratio15", 
                                                            "pod.ratio20",
                                                            "pod.ratio25", 
                                                            "pod.ratio30",
                                                            
                                                            "ratio5.min.broad", # Min Broad POD ratios
                                                            "ratio10.min.broad",
                                                            "ratio15.min.broad",
                                                            "ratio20.min.broad",
                                                            "ratio25.min.broad",
                                                            "ratio30.min.broad",
                                                             
                                                            "ratio5.min.target", # Min Targeted POD ratios
                                                            "ratio10.min.target",
                                                            "ratio15.min.target",
                                                            "ratio20.min.target",
                                                            "ratio25.min.target", 
                                                            "ratio30.min.target", 
                                                            
                                                            "ratio5.med.broad", # Med Broad POD ratios
                                                            "ratio10.med.broad", 
                                                            "ratio15.med.broad", 
                                                            "ratio20.med.broad", 
                                                            "ratio25.med.broad", 
                                                            "ratio30.med.broad", 
                                                            
                                                            "ratio5.med.target", # Med targeted pod ratios
                                                            "ratio10.med.target", 
                                                            "ratio15.med.target", 
                                                            "ratio20.med.target", 
                                                            "ratio25.med.target", 
                                                            "ratio30.med.target",  
                                                            
                                                            "ratio5.atg", # individual assays
                                                            "ratio5.biomap",
                                                            "ratio5.nvs", 
                                                            "ratio5.stm",
                                                            
                                                            "ratio5.htpp.u2os", 
                                                            "ratio5.httr.heparg",
                                                            "ratio5.httr.mcf7", 
                                                            "ratio5.httr.u2os", 
                                                             
                                                            "ratio5.hipptox.beas2b", 
                                                            "ratio5.hipptox.hepg2",
                                                            "ratio5.hipptox.hk2",
                                                            
                                                            
                                                            "ratio5.mlr5", #MLR models
                                                            "ratio25.mlr25",
                                                            
                                                            "ratio5.med.coretarget", # other ratios from figures - not in table2
                                                            "ratio5.med.hipptox", 
                                                            "ratio5.med.brta", 
                                                            "ratio25.med.coretarget", 
                                                            "ratio25.med.hipptox", 
                                                            "ratio25.med.brta"
                                                            )])

```

```{r, warning=FALSE}
counts_ratios_notNA <- as.data.frame(sapply(asnm.ratio.counts, function(x) sum(!is.na(x))))
count_ratios_gte0 <- as.data.frame(sapply(asnm.ratio.counts, function(x) sum(x >=0, na.rm=TRUE)))
count_ratios_win2 <- as.data.frame(sapply(asnm.ratio.counts, function(x) sum(x >= -2 & x<=2, na.rm=TRUE)))
count_ratios_gteneg2 <- as.data.frame(sapply(asnm.ratio.counts, function(x) sum(x >= -2, na.rm=TRUE)))

asnm.summary.counts <- cbind.data.frame(counts_ratios_notNA,
                                                      count_ratios_gte0,
                                                      count_ratios_win2,
                                        count_ratios_gteneg2)

asnm.summary.counts <- rownames_to_column(asnm.summary.counts, var="RatioType")
asnm.summary.counts <- as.data.table(asnm.summary.counts)
setnames(asnm.summary.counts, c(2,3,4,5), c('count','count-gte0','count-win2', 'count-gteneg2'))

asnm.summary.counts[,podratiogt0 := round(((count_ratios_gte0/158)*100),1)]
asnm.summary.counts[,podratiowin2 := round(((count_ratios_win2/158)*100),1)]
asnm.summary.counts[,podratiogteneg2 := round(((count_ratios_gteneg2/158)*100),1)]

```

Merge with performance Table 2.

```{r, warning=FALSE}

tbl2.part2 <- asnm.summary.counts[-c(1:25,75:80),]

nr <- max(nrow(models_performance_summary), nrow(tbl2.part2))
tbl2 <- cbind(models_performance_summary[1:nr, ], tbl2.part2[1:nr, ])

```

Write files

```{r, warning=FALSE}


list_data <- list("Table2" = as.data.frame(tbl2),
                  "All-pod-ratios" = as.data.frame(asnm.tier1.all.ratios))

write.xlsx(list_data, './output/table2_podratios_29nov2024.xlsx')
```

# Reproducibility

```{r print-session-info, warning=FALSE}

print(sessionInfo())

```







